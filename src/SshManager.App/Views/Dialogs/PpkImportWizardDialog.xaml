<ui:FluentWindow x:Class="SshManager.App.Views.Dialogs.PpkImportWizardDialog"
                xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
                xmlns:converters="clr-namespace:SshManager.App.Converters"
                mc:Ignorable="d"
                Title="PPK Import Wizard"
                Height="650" Width="900"
                MinHeight="600" MinWidth="800"
                WindowStartupLocation="CenterOwner"
                ExtendsContentIntoTitleBar="True"
                WindowBackdropType="Mica"
                AllowDrop="True"
                Drop="Window_Drop">

    <ui:FluentWindow.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter" />
        <converters:GreaterThanOrEqualConverter x:Key="GreaterThanOrEqualConverter" />
    </ui:FluentWindow.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Title Bar -->
        <ui:TitleBar Grid.Row="0"
                     Title="PPK Import Wizard"
                     ShowMaximize="True"
                     ShowMinimize="False" />

        <!-- Step Indicator -->
        <Border Grid.Row="1"
               Background="{ui:ThemeResource ControlFillColorDefaultBrush}"
               Padding="24,16">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <!-- Step 1 -->
                <StackPanel Grid.Column="0" HorizontalAlignment="Center">
                    <Border Width="40" Height="40"
                           CornerRadius="20"
                           HorizontalAlignment="Center">
                        <Border.Style>
                            <Style TargetType="Border">
                                <Setter Property="Background" Value="#444444" />
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding CurrentStep, Converter={StaticResource GreaterThanOrEqualConverter}, ConverterParameter=1}" Value="True">
                                        <Setter Property="Background" Value="{ui:ThemeResource AccentTextFillColorPrimaryBrush}" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>
                        <TextBlock Text="1" FontSize="18" FontWeight="Bold"
                                  HorizontalAlignment="Center" VerticalAlignment="Center" />
                    </Border>
                    <TextBlock Text="Select Files"
                              HorizontalAlignment="Center"
                              Margin="0,8,0,0"
                              FontSize="12" />
                </StackPanel>

                <!-- Step 2 -->
                <StackPanel Grid.Column="1" HorizontalAlignment="Center">
                    <Border Width="40" Height="40"
                           CornerRadius="20"
                           HorizontalAlignment="Center">
                        <Border.Style>
                            <Style TargetType="Border">
                                <Setter Property="Background" Value="#444444" />
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding CurrentStep, Converter={StaticResource GreaterThanOrEqualConverter}, ConverterParameter=2}" Value="True">
                                        <Setter Property="Background" Value="{ui:ThemeResource AccentTextFillColorPrimaryBrush}" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>
                        <TextBlock Text="2" FontSize="18" FontWeight="Bold"
                                  HorizontalAlignment="Center" VerticalAlignment="Center" />
                    </Border>
                    <TextBlock Text="Authentication"
                              HorizontalAlignment="Center"
                              Margin="0,8,0,0"
                              FontSize="12" />
                </StackPanel>

                <!-- Step 3 -->
                <StackPanel Grid.Column="2" HorizontalAlignment="Center">
                    <Border Width="40" Height="40"
                           CornerRadius="20"
                           HorizontalAlignment="Center">
                        <Border.Style>
                            <Style TargetType="Border">
                                <Setter Property="Background" Value="#444444" />
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding CurrentStep, Converter={StaticResource GreaterThanOrEqualConverter}, ConverterParameter=3}" Value="True">
                                        <Setter Property="Background" Value="{ui:ThemeResource AccentTextFillColorPrimaryBrush}" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>
                        <TextBlock Text="3" FontSize="18" FontWeight="Bold"
                                  HorizontalAlignment="Center" VerticalAlignment="Center" />
                    </Border>
                    <TextBlock Text="Options"
                              HorizontalAlignment="Center"
                              Margin="0,8,0,0"
                              FontSize="12" />
                </StackPanel>

                <!-- Step 4 -->
                <StackPanel Grid.Column="3" HorizontalAlignment="Center">
                    <Border Width="40" Height="40"
                           CornerRadius="20"
                           HorizontalAlignment="Center">
                        <Border.Style>
                            <Style TargetType="Border">
                                <Setter Property="Background" Value="#444444" />
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding CurrentStep, Converter={StaticResource GreaterThanOrEqualConverter}, ConverterParameter=4}" Value="True">
                                        <Setter Property="Background" Value="{ui:ThemeResource AccentTextFillColorPrimaryBrush}" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>
                        <TextBlock Text="4" FontSize="18" FontWeight="Bold"
                                  HorizontalAlignment="Center" VerticalAlignment="Center" />
                    </Border>
                    <TextBlock Text="Import"
                              HorizontalAlignment="Center"
                              Margin="0,8,0,0"
                              FontSize="12" />
                </StackPanel>
            </Grid>
        </Border>

        <!-- Content Area -->
        <Grid Grid.Row="2" Margin="16">
            <!-- Step 1: File Selection -->
            <Grid Visibility="{Binding IsStep1, Converter={StaticResource BoolToVisibilityConverter}}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!-- Header -->
                <StackPanel Grid.Row="0" Margin="0,0,0,16">
                    <TextBlock Text="Select PPK Files to Import"
                              FontSize="20"
                              FontWeight="SemiBold" />
                    <TextBlock Text="Choose one or more PuTTY Private Key files to convert to OpenSSH format. You can drag and drop files into this window."
                              TextWrapping="Wrap"
                              Opacity="0.7"
                              Margin="0,4,0,0" />
                </StackPanel>

                <!-- Toolbar -->
                <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,8">
                    <ui:Button Icon="{ui:SymbolIcon Add24}"
                              Content="Add Files..."
                              Command="{Binding BrowseFilesAsyncCommand}"
                              Margin="0,0,8,0" />
                    <ui:Button Icon="{ui:SymbolIcon Delete24}"
                              Content="Remove Selected"
                              Command="{Binding RemoveSelectedFileCommand}"
                              Margin="0,0,8,0" />
                    <ui:Button Content="Remove All"
                              Command="{Binding RemoveAllFilesCommand}"
                              Margin="0,0,8,0" />
                    <TextBlock Text="{Binding SelectedFileCount, StringFormat='{}{0} file(s) selected'}"
                              VerticalAlignment="Center"
                              Margin="16,0,0,0"
                              FontWeight="SemiBold" />
                </StackPanel>

                <!-- Files List -->
                <DataGrid Grid.Row="2"
                         ItemsSource="{Binding Items}"
                         SelectedItem="{Binding SelectedItem}"
                         AutoGenerateColumns="False"
                         SelectionMode="Single"
                         CanUserAddRows="False"
                         CanUserDeleteRows="False"
                         HeadersVisibility="Column"
                         GridLinesVisibility="Horizontal">
                    <DataGrid.Columns>
                        <DataGridTemplateColumn Header="" Width="40">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <CheckBox IsChecked="{Binding IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                             HorizontalAlignment="Center" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>

                        <DataGridTextColumn Header="File Name"
                                           Binding="{Binding FileName}"
                                           Width="*"
                                           MinWidth="200" />

                        <DataGridTextColumn Header="Key Type"
                                           Binding="{Binding DisplayKeyType}"
                                           Width="140" />

                        <DataGridTextColumn Header="Encrypted"
                                           Binding="{Binding DisplayEncrypted}"
                                           Width="80" />

                        <DataGridTextColumn Header="Comment"
                                           Binding="{Binding DisplayComment}"
                                           Width="*"
                                           MinWidth="150" />
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>

            <!-- Step 2: Authentication -->
            <Grid Visibility="{Binding IsStep2, Converter={StaticResource BoolToVisibilityConverter}}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!-- Header -->
                <StackPanel Grid.Row="0" Margin="0,0,0,16">
                    <TextBlock Text="Enter Passphrases for Encrypted Keys"
                              FontSize="20"
                              FontWeight="SemiBold" />
                    <TextBlock TextWrapping="Wrap" Opacity="0.7" Margin="0,4,0,0">
                        <Run Text="The following" />
                        <Run Text="{Binding EncryptedFileCount, Mode=OneWay}" FontWeight="SemiBold" />
                        <Run Text="file(s) are encrypted. Please provide the passphrase for each file." />
                    </TextBlock>
                </StackPanel>

                <!-- Encrypted Files List -->
                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                    <ItemsControl ItemsSource="{Binding Items}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Margin="0,0,0,12"
                                       Padding="16"
                                       Background="{ui:ThemeResource ControlFillColorDefaultBrush}"
                                       CornerRadius="6"
                                       Visibility="{Binding Info.IsEncrypted, Converter={StaticResource BoolToVisibilityConverter}}">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                        </Grid.RowDefinitions>

                                        <StackPanel Grid.Row="0">
                                            <TextBlock Text="{Binding FileName}"
                                                      FontWeight="SemiBold"
                                                      FontSize="14" />
                                            <TextBlock Opacity="0.7" FontSize="12" Margin="0,2,0,0">
                                                <Run Text="{Binding DisplayKeyType}" />
                                                <Run Text=" - " />
                                                <Run Text="{Binding DisplayComment}" />
                                            </TextBlock>
                                        </StackPanel>

                                        <StackPanel Grid.Row="1" Margin="0,8,0,0">
                                            <TextBlock Text="Passphrase"
                                                      FontWeight="SemiBold"
                                                      FontSize="12"
                                                      Margin="0,0,0,4" />
                                            <PasswordBox x:Name="PassphraseBox"
                                                        PasswordChanged="PassphraseBox_PasswordChanged"
                                                        Tag="{Binding}" />
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>

            <!-- Step 3: Options -->
            <ScrollViewer Visibility="{Binding IsStep3, Converter={StaticResource BoolToVisibilityConverter}}"
                         VerticalScrollBarVisibility="Auto">
                <StackPanel>
                    <!-- Header -->
                    <TextBlock Text="Import Options"
                              FontSize="20"
                              FontWeight="SemiBold"
                              Margin="0,0,0,4" />
                    <TextBlock Text="Configure how the keys should be imported and saved."
                              TextWrapping="Wrap"
                              Opacity="0.7"
                              Margin="0,0,0,24" />

                    <!-- Output Directory -->
                    <ui:CardControl Margin="0,0,0,16">
                        <ui:CardControl.Header>
                            <StackPanel>
                                <TextBlock Text="Output Directory" FontWeight="SemiBold" />
                                <TextBlock Text="Where should the converted keys be saved?"
                                          FontSize="12" Opacity="0.7" />
                            </StackPanel>
                        </ui:CardControl.Header>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <ui:TextBox Grid.Column="0"
                                       Text="{Binding OutputDirectory, UpdateSourceTrigger=PropertyChanged}"
                                       PlaceholderText="Select output directory" />
                            <ui:Button Grid.Column="1"
                                      Content="Browse..."
                                      Command="{Binding BrowseOutputDirectoryCommand}"
                                      Margin="8,0,0,0" />
                        </Grid>
                    </ui:CardControl>

                    <!-- Re-encryption -->
                    <ui:CardControl Margin="0,0,0,16">
                        <ui:CardControl.Header>
                            <StackPanel>
                                <TextBlock Text="Key Encryption" FontWeight="SemiBold" />
                                <TextBlock Text="Optionally protect the converted keys with a new passphrase."
                                          FontSize="12" Opacity="0.7" />
                            </StackPanel>
                        </ui:CardControl.Header>
                        <StackPanel>
                            <CheckBox Content="Re-encrypt keys with new passphrase"
                                     IsChecked="{Binding ReEncryptKeys}"
                                     Margin="0,0,0,8" />
                            <StackPanel Visibility="{Binding ReEncryptKeys, Converter={StaticResource BoolToVisibilityConverter}}">
                                <TextBlock Text="New Passphrase"
                                          FontWeight="SemiBold"
                                          FontSize="12"
                                          Margin="0,0,0,4" />
                                <PasswordBox x:Name="NewPassphraseBox"
                                            PasswordChanged="NewPassphraseBox_PasswordChanged"
                                            Margin="0,0,0,4" />
                                <TextBlock Text="This passphrase will be used to encrypt all converted keys."
                                          FontSize="11"
                                          Opacity="0.6" />
                            </StackPanel>
                        </StackPanel>
                    </ui:CardControl>

                    <!-- Additional Options -->
                    <ui:CardControl Margin="0,0,0,16">
                        <ui:CardControl.Header>
                            <StackPanel>
                                <TextBlock Text="Additional Options" FontWeight="SemiBold" />
                                <TextBlock Text="Configure post-import actions."
                                          FontSize="12" Opacity="0.7" />
                            </StackPanel>
                        </ui:CardControl.Header>
                        <StackPanel>
                            <CheckBox Content="Add keys to SSH agent after import"
                                     IsChecked="{Binding AddToAgent}"
                                     Margin="0,0,0,8">
                                <CheckBox.ToolTip>
                                    <TextBlock Text="Automatically load converted keys into your SSH agent (Pageant or OpenSSH Agent)"
                                              TextWrapping="Wrap" MaxWidth="300" />
                                </CheckBox.ToolTip>
                            </CheckBox>
                            <CheckBox Content="Track keys in database"
                                     IsChecked="{Binding TrackInDatabase}">
                                <CheckBox.ToolTip>
                                    <TextBlock Text="Add imported keys to the managed keys list for easier management"
                                              TextWrapping="Wrap" MaxWidth="300" />
                                </CheckBox.ToolTip>
                            </CheckBox>
                        </StackPanel>
                    </ui:CardControl>

                    <!-- Summary -->
                    <Border Background="#1F0078D4"
                           CornerRadius="6"
                           Padding="16">
                        <StackPanel>
                            <TextBlock Text="Summary" FontWeight="SemiBold" FontSize="14" />
                            <TextBlock TextWrapping="Wrap" Margin="0,8,0,0">
                                <Run Text="Files to import:" />
                                <Run Text="{Binding SelectedFileCount, Mode=OneWay}" FontWeight="SemiBold" />
                            </TextBlock>
                            <TextBlock TextWrapping="Wrap" Margin="0,4,0,0">
                                <Run Text="Output directory:" />
                                <Run Text="{Binding OutputDirectory, Mode=OneWay}" FontWeight="SemiBold" />
                            </TextBlock>
                            <TextBlock TextWrapping="Wrap" Margin="0,4,0,0"
                                      Visibility="{Binding ReEncryptKeys, Converter={StaticResource BoolToVisibilityConverter}}">
                                <Run Text="Keys will be re-encrypted with a new passphrase" />
                            </TextBlock>
                            <TextBlock TextWrapping="Wrap" Margin="0,4,0,0"
                                      Visibility="{Binding AddToAgent, Converter={StaticResource BoolToVisibilityConverter}}">
                                <Run Text="Keys will be added to SSH agent" />
                            </TextBlock>
                            <TextBlock TextWrapping="Wrap" Margin="0,4,0,0"
                                      Visibility="{Binding TrackInDatabase, Converter={StaticResource BoolToVisibilityConverter}}">
                                <Run Text="Keys will be tracked in database" />
                            </TextBlock>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </ScrollViewer>

            <!-- Step 4: Import Progress -->
            <Grid Visibility="{Binding IsStep4, Converter={StaticResource BoolToVisibilityConverter}}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!-- Header -->
                <StackPanel Grid.Row="0" Margin="0,0,0,16">
                    <TextBlock Text="Importing Keys"
                              FontSize="20"
                              FontWeight="SemiBold" />
                    <TextBlock Text="Converting and saving your PPK files..."
                              TextWrapping="Wrap"
                              Opacity="0.7"
                              Margin="0,4,0,0" />
                </StackPanel>

                <!-- Progress -->
                <StackPanel Grid.Row="1" Margin="0,0,0,16">
                    <TextBlock Text="{Binding ProgressStatus}"
                              FontWeight="SemiBold"
                              Margin="0,0,0,8" />
                    <ProgressBar Value="{Binding ProgressValue}"
                                Maximum="{Binding ProgressMaximum}"
                                Height="8" />
                    <TextBlock Margin="0,4,0,0" Opacity="0.7">
                        <Run Text="{Binding ProgressValue, Mode=OneWay}" />
                        <Run Text=" / " />
                        <Run Text="{Binding ProgressMaximum, Mode=OneWay}" />
                    </TextBlock>
                </StackPanel>

                <!-- Results List -->
                <DataGrid Grid.Row="2"
                         ItemsSource="{Binding Items}"
                         AutoGenerateColumns="False"
                         SelectionMode="Single"
                         CanUserAddRows="False"
                         CanUserDeleteRows="False"
                         HeadersVisibility="Column"
                         GridLinesVisibility="Horizontal"
                         IsReadOnly="True">
                    <DataGrid.Columns>
                        <DataGridTemplateColumn Header="" Width="40">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <ui:SymbolIcon FontSize="16" HorizontalAlignment="Center">
                                        <ui:SymbolIcon.Style>
                                            <Style TargetType="ui:SymbolIcon">
                                                <Setter Property="Symbol" Value="Circle24" />
                                                <Setter Property="Foreground" Value="Gray" />
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Status}" Value="InProgress">
                                                        <Setter Property="Symbol" Value="ArrowSync24" />
                                                        <Setter Property="Foreground" Value="Orange" />
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding Status}" Value="Success">
                                                        <Setter Property="Symbol" Value="CheckmarkCircle24" />
                                                        <Setter Property="Foreground" Value="LimeGreen" />
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding Status}" Value="Failed">
                                                        <Setter Property="Symbol" Value="DismissCircle24" />
                                                        <Setter Property="Foreground" Value="Red" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </ui:SymbolIcon.Style>
                                    </ui:SymbolIcon>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>

                        <DataGridTextColumn Header="File Name"
                                           Binding="{Binding FileName}"
                                           Width="*"
                                           MinWidth="200" />

                        <DataGridTextColumn Header="Status"
                                           Binding="{Binding DisplayStatus}"
                                           Width="*"
                                           MinWidth="150" />

                        <DataGridTextColumn Header="Saved To"
                                           Binding="{Binding SavedPath}"
                                           Width="*"
                                           MinWidth="200" />
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </Grid>

        <!-- Action Buttons -->
        <Grid Grid.Row="3" Margin="16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <!-- Status Message -->
            <TextBlock Grid.Column="0"
                      Text="{Binding StatusMessage}"
                      VerticalAlignment="Center"
                      Opacity="0.7" />

            <!-- Previous Button -->
            <ui:Button Grid.Column="2"
                      Content="Previous"
                      Command="{Binding PreviousStepCommand}"
                      Visibility="{Binding CanGoPrevious, Converter={StaticResource BoolToVisibilityConverter}}"
                      MinWidth="80"
                      Margin="0,0,8,0" />

            <!-- Next Button -->
            <ui:Button Grid.Column="3"
                      Content="Next"
                      Appearance="Primary"
                      Command="{Binding NextStepCommand}"
                      Visibility="{Binding CanGoNext, Converter={StaticResource BoolToVisibilityConverter}}"
                      MinWidth="80"
                      Margin="0,0,8,0" />

            <!-- Import Button -->
            <ui:Button Grid.Column="3"
                      Content="Import"
                      Appearance="Primary"
                      Command="{Binding ImportCommand}"
                      Visibility="{Binding CanImport, Converter={StaticResource BoolToVisibilityConverter}}"
                      MinWidth="80"
                      Margin="0,0,8,0" />

            <!-- Close Button -->
            <ui:Button Grid.Column="4"
                      Content="Close"
                      Command="{Binding CloseCommand}"
                      MinWidth="80" />
        </Grid>
    </Grid>
</ui:FluentWindow>
