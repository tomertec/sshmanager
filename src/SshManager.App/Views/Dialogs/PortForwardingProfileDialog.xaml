<ui:FluentWindow x:Class="SshManager.App.Views.Dialogs.PortForwardingProfileDialog"
                xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
                xmlns:converters="clr-namespace:SshManager.App.Converters"
                xmlns:models="clr-namespace:SshManager.Core.Models;assembly=SshManager.Core"
                mc:Ignorable="d"
                Title="{Binding Title}"
                Height="600" Width="480"
                MinHeight="550" MinWidth="450"
                WindowStartupLocation="CenterOwner"
                ResizeMode="NoResize"
                ExtendsContentIntoTitleBar="True"
                WindowBackdropType="Mica">

    <ui:FluentWindow.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <converters:StringToVisibilityConverter x:Key="StringToVisibilityConverter" />
    </ui:FluentWindow.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Title Bar -->
        <ui:TitleBar Grid.Row="0"
                     Title="{Binding Title}"
                     ShowMaximize="False"
                     ShowMinimize="False" />

        <!-- Form Content -->
        <ScrollViewer Grid.Row="1"
                      VerticalScrollBarVisibility="Auto"
                      Padding="24,16">
            <StackPanel>
                <!-- Display Name -->
                <TextBlock Text="Display Name *"
                          FontWeight="SemiBold"
                          Margin="0,0,0,4" />
                <ui:TextBox Text="{Binding DisplayName, UpdateSourceTrigger=PropertyChanged}"
                           PlaceholderText="MySQL Tunnel"
                           Margin="0,0,0,16" />

                <!-- Description -->
                <TextBlock Text="Description"
                          FontWeight="SemiBold"
                          Margin="0,0,0,4" />
                <ui:TextBox Text="{Binding Description, UpdateSourceTrigger=PropertyChanged}"
                           PlaceholderText="Optional description..."
                           AcceptsReturn="True"
                           TextWrapping="Wrap"
                           MinHeight="40"
                           MaxHeight="60"
                           Margin="0,0,0,16" />

                <!-- Forwarding Type -->
                <TextBlock Text="Forwarding Type"
                          FontWeight="SemiBold"
                          Margin="0,0,0,4" />
                <ComboBox ItemsSource="{Binding ForwardingTypes}"
                         SelectedItem="{Binding ForwardingType}"
                         Margin="0,0,0,8">
                    <ComboBox.ItemTemplate>
                        <DataTemplate>
                            <TextBlock>
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Text" Value="{Binding}" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding}" Value="{x:Static models:PortForwardingType.LocalForward}">
                                                <Setter Property="Text" Value="Local Forward (-L)" />
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding}" Value="{x:Static models:PortForwardingType.RemoteForward}">
                                                <Setter Property="Text" Value="Remote Forward (-R)" />
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding}" Value="{x:Static models:PortForwardingType.DynamicForward}">
                                                <Setter Property="Text" Value="Dynamic Forward (-D) - SOCKS5" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </DataTemplate>
                    </ComboBox.ItemTemplate>
                </ComboBox>

                <!-- Type Description -->
                <TextBlock Text="{Binding ForwardingTypeDescription}"
                          FontSize="11"
                          Opacity="0.6"
                          TextWrapping="Wrap"
                          Margin="0,0,0,16" />

                <!-- Local Side Section -->
                <Border Background="#1FFFFFFF"
                        CornerRadius="8"
                        BorderBrush="#2FFFFFFF"
                        BorderThickness="1"
                        Padding="16"
                        Margin="0,0,0,16">
                    <StackPanel>
                        <TextBlock Text="Local Side"
                                  FontWeight="SemiBold"
                                  FontSize="13"
                                  Margin="0,0,0,12" />

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="8" />
                                <ColumnDefinition Width="100" />
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <!-- Bind Address Label -->
                            <TextBlock Grid.Row="0" Grid.Column="0"
                                      Text="Bind Address"
                                      FontWeight="SemiBold"
                                      FontSize="12"
                                      Margin="0,0,0,4" />

                            <!-- Port Label -->
                            <TextBlock Grid.Row="0" Grid.Column="2"
                                      Text="Port *"
                                      FontWeight="SemiBold"
                                      FontSize="12"
                                      Margin="0,0,0,4" />

                            <!-- Bind Address Input -->
                            <ui:TextBox Grid.Row="1" Grid.Column="0"
                                       Text="{Binding LocalBindAddress, UpdateSourceTrigger=PropertyChanged}"
                                       PlaceholderText="127.0.0.1" />

                            <!-- Port Input -->
                            <ui:NumberBox Grid.Row="1" Grid.Column="2"
                                         Value="{Binding LocalPort}"
                                         Minimum="1"
                                         Maximum="65535"
                                         SpinButtonPlacementMode="Hidden" />
                        </Grid>

                        <TextBlock Text="Use 127.0.0.1 for local-only, 0.0.0.0 to allow external connections"
                                  FontSize="10"
                                  Opacity="0.5"
                                  Margin="0,8,0,0" />
                    </StackPanel>
                </Border>

                <!-- Remote Side Section (hidden for Dynamic Forward) -->
                <Border Background="#1FFFFFFF"
                        CornerRadius="8"
                        BorderBrush="#2FFFFFFF"
                        BorderThickness="1"
                        Padding="16"
                        Margin="0,0,0,16"
                        Visibility="{Binding ShowRemoteFields, Converter={StaticResource BoolToVisibilityConverter}}">
                    <StackPanel>
                        <TextBlock Text="Remote Side"
                                  FontWeight="SemiBold"
                                  FontSize="13"
                                  Margin="0,0,0,12" />

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="8" />
                                <ColumnDefinition Width="100" />
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <!-- Host Label -->
                            <TextBlock Grid.Row="0" Grid.Column="0"
                                      Text="Host *"
                                      FontWeight="SemiBold"
                                      FontSize="12"
                                      Margin="0,0,0,4" />

                            <!-- Port Label -->
                            <TextBlock Grid.Row="0" Grid.Column="2"
                                      Text="Port *"
                                      FontWeight="SemiBold"
                                      FontSize="12"
                                      Margin="0,0,0,4" />

                            <!-- Host Input -->
                            <ui:TextBox Grid.Row="1" Grid.Column="0"
                                       Text="{Binding RemoteHost, UpdateSourceTrigger=PropertyChanged}"
                                       PlaceholderText="localhost" />

                            <!-- Port Input -->
                            <ui:NumberBox Grid.Row="1" Grid.Column="2"
                                         Value="{Binding RemotePort}"
                                         Minimum="1"
                                         Maximum="65535"
                                         SpinButtonPlacementMode="Hidden" />
                        </Grid>

                        <TextBlock Text="Use 'localhost' for services on the SSH server itself"
                                  FontSize="10"
                                  Opacity="0.5"
                                  Margin="0,8,0,0" />
                    </StackPanel>
                </Border>

                <!-- Associated Host -->
                <TextBlock Text="Associated Host"
                          FontWeight="SemiBold"
                          Margin="0,0,0,4" />
                <ComboBox ItemsSource="{Binding AvailableHosts}"
                         SelectedItem="{Binding SelectedHost}"
                         Margin="0,0,0,8">
                    <ComboBox.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{Binding DisplayName}" />
                                <TextBlock Text=" - " Opacity="0.5" />
                                <TextBlock Text="{Binding Hostname}" Opacity="0.6" />
                            </StackPanel>
                        </DataTemplate>
                    </ComboBox.ItemTemplate>
                </ComboBox>
                <TextBlock Text="Leave empty for a global profile available for all hosts"
                          FontSize="11"
                          Opacity="0.5"
                          Margin="0,0,0,16" />

                <!-- Options -->
                <Grid Margin="0,0,0,16">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <CheckBox Grid.Column="0"
                             Content="Enabled"
                             IsChecked="{Binding IsEnabled}" />

                    <CheckBox Grid.Column="1"
                             Content="Auto-start on connect"
                             IsChecked="{Binding AutoStart}" />
                </Grid>

                <!-- Command Preview -->
                <Border Background="#0C3A5E"
                        CornerRadius="6"
                        Padding="12"
                        Margin="0,0,0,16">
                    <StackPanel>
                        <TextBlock Text="SSH Command Equivalent"
                                  FontWeight="SemiBold"
                                  FontSize="11"
                                  Opacity="0.7"
                                  Margin="0,0,0,4" />
                        <TextBlock Text="{Binding CommandPreview}"
                                  FontFamily="Consolas"
                                  Foreground="#80CAFF" />
                    </StackPanel>
                </Border>

                <!-- Validation Error -->
                <Border Background="#3A1A1A"
                        CornerRadius="6"
                        Padding="12"
                        Margin="0,0,0,8"
                        Visibility="{Binding ValidationError, Converter={StaticResource StringToVisibilityConverter}}">
                    <StackPanel Orientation="Horizontal">
                        <ui:SymbolIcon Symbol="Warning24"
                                      Foreground="#FF6B6B"
                                      Margin="0,0,8,0" />
                        <TextBlock Text="{Binding ValidationError}"
                                  Foreground="#FF6B6B"
                                  TextWrapping="Wrap" />
                    </StackPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>

        <!-- Loading Overlay -->
        <Border Grid.Row="1"
                Background="#80000000"
                Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibilityConverter}}">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <ui:ProgressRing IsIndeterminate="True" Width="40" Height="40" />
                <TextBlock Text="Saving..." Margin="0,8,0,0" />
            </StackPanel>
        </Border>

        <!-- Action Buttons -->
        <Grid Grid.Row="2" Margin="24,16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <ui:Button Grid.Column="1"
                      Content="Cancel"
                      Command="{Binding CancelCommand}"
                      Margin="0,0,8,0"
                      MinWidth="80" />

            <ui:Button Grid.Column="2"
                      Content="Save"
                      Appearance="Primary"
                      Command="{Binding SaveCommand}"
                      MinWidth="80" />
        </Grid>
    </Grid>
</ui:FluentWindow>
