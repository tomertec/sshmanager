<ui:FluentWindow x:Class="SshManager.App.Views.Dialogs.TunnelBuilderDialog"
                xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
                xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
                xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
                xmlns:models="clr-namespace:SshManager.Core.Models;assembly=SshManager.Core"
                xmlns:viewmodels="clr-namespace:SshManager.App.ViewModels"
                xmlns:converters="clr-namespace:SshManager.App.Converters"
                xmlns:controls="clr-namespace:SshManager.App.Views.Controls"
                mc:Ignorable="d"
                Title="SSH Tunnel Builder"
                Height="700" Width="1100"
                MinHeight="600" MinWidth="800"
                WindowStartupLocation="CenterOwner"
                ResizeMode="CanResizeWithGrip"
                ExtendsContentIntoTitleBar="True"
                WindowBackdropType="Mica">

    <ui:FluentWindow.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <converters:CountToVisibilityConverter x:Key="CountToVisibilityConverter" />
        <converters:EqualityToVisibilityConverter x:Key="EqualityToVisibilityConverter" />
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter" />
        <converters:StringToVisibilityConverter x:Key="StringToVisibilityConverter" />
    </ui:FluentWindow.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Snackbar Presenter for dialog-local notifications -->
        <ui:SnackbarPresenter x:Name="DialogSnackbarPresenter" Grid.Row="1" VerticalAlignment="Bottom" Margin="0,0,0,8" />

        <!-- Title Bar -->
        <ui:TitleBar Grid.Row="0"
                     Title="SSH Tunnel Builder"
                     ShowMaximize="True"
                     ShowMinimize="False" />

        <!-- Main Content -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="200" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="320" />
            </Grid.ColumnDefinitions>

            <!-- Left Column - Node Palette -->
            <Border Grid.Column="0"
                    Background="#0D000000"
                    BorderBrush="#20FFFFFF"
                    BorderThickness="0,0,1,0"
                    Padding="12">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <!-- Add Nodes Section -->
                        <TextBlock Text="Add Nodes"
                                  FontWeight="SemiBold"
                                  FontSize="14"
                                  Margin="0,0,0,12" />

                        <!-- Local Machine Node -->
                        <ui:Button Command="{Binding AddNodeCommand}"
                                  CommandParameter="{x:Static models:TunnelNodeType.LocalMachine}"
                                  HorizontalAlignment="Stretch"
                                  Margin="0,0,0,8"
                                  Padding="8">
                            <StackPanel Orientation="Horizontal">
                                <ui:SymbolIcon Symbol="Desktop24" FontSize="16" Margin="0,0,8,0" />
                                <TextBlock Text="Local Machine" VerticalAlignment="Center" />
                            </StackPanel>
                        </ui:Button>

                        <!-- SSH Host Node -->
                        <ui:Button Command="{Binding AddNodeCommand}"
                                  CommandParameter="{x:Static models:TunnelNodeType.SshHost}"
                                  HorizontalAlignment="Stretch"
                                  Margin="0,0,0,8"
                                  Padding="8">
                            <StackPanel Orientation="Horizontal">
                                <ui:SymbolIcon Symbol="Server24" FontSize="16" Margin="0,0,8,0" />
                                <TextBlock Text="SSH Host" VerticalAlignment="Center" />
                            </StackPanel>
                        </ui:Button>

                        <!-- Local Port Node -->
                        <ui:Button Command="{Binding AddNodeCommand}"
                                  CommandParameter="{x:Static models:TunnelNodeType.LocalPort}"
                                  HorizontalAlignment="Stretch"
                                  Margin="0,0,0,8"
                                  Padding="8">
                            <StackPanel Orientation="Horizontal">
                                <ui:SymbolIcon Symbol="PlugConnected24" FontSize="16" Margin="0,0,8,0" />
                                <TextBlock Text="Local Port" VerticalAlignment="Center" />
                            </StackPanel>
                        </ui:Button>

                        <!-- Remote Port Node -->
                        <ui:Button Command="{Binding AddNodeCommand}"
                                  CommandParameter="{x:Static models:TunnelNodeType.RemotePort}"
                                  HorizontalAlignment="Stretch"
                                  Margin="0,0,0,8"
                                  Padding="8">
                            <StackPanel Orientation="Horizontal">
                                <ui:SymbolIcon Symbol="CloudArrowUp24" FontSize="16" Margin="0,0,8,0" />
                                <TextBlock Text="Remote Port" VerticalAlignment="Center" />
                            </StackPanel>
                        </ui:Button>

                        <!-- Dynamic Proxy Node -->
                        <ui:Button Command="{Binding AddNodeCommand}"
                                  CommandParameter="{x:Static models:TunnelNodeType.DynamicProxy}"
                                  HorizontalAlignment="Stretch"
                                  Margin="0,0,0,8"
                                  Padding="8">
                            <StackPanel Orientation="Horizontal">
                                <ui:SymbolIcon Symbol="ShieldKeyhole24" FontSize="16" Margin="0,0,8,0" />
                                <TextBlock Text="SOCKS Proxy" VerticalAlignment="Center" />
                            </StackPanel>
                        </ui:Button>

                        <!-- Target Host Node -->
                        <ui:Button Command="{Binding AddNodeCommand}"
                                  CommandParameter="{x:Static models:TunnelNodeType.TargetHost}"
                                  HorizontalAlignment="Stretch"
                                  Margin="0,0,0,8"
                                  Padding="8">
                            <StackPanel Orientation="Horizontal">
                                <ui:SymbolIcon Symbol="ArrowSync24" FontSize="16" Margin="0,0,8,0" />
                                <TextBlock Text="Target Host" VerticalAlignment="Center" />
                            </StackPanel>
                        </ui:Button>

                        <!-- Actions Section -->
                        <TextBlock Text="Actions"
                                  FontWeight="SemiBold"
                                  FontSize="14"
                                  Margin="0,16,0,12" />

                        <!-- Connect Nodes -->
                        <ui:Button Command="{Binding ConnectNodesCommand}"
                                  HorizontalAlignment="Stretch"
                                  Appearance="Primary"
                                  Margin="0,0,0,8"
                                  Padding="8">
                            <StackPanel Orientation="Horizontal">
                                <ui:SymbolIcon Symbol="ArrowRight24" FontSize="16" Margin="0,0,8,0" />
                                <TextBlock Text="Connect Nodes" VerticalAlignment="Center" />
                            </StackPanel>
                        </ui:Button>

                        <!-- Remove Selected -->
                        <ui:Button Command="{Binding RemoveNodeCommand}"
                                  HorizontalAlignment="Stretch"
                                  Appearance="Secondary"
                                  Margin="0,0,0,8"
                                  Padding="8">
                            <StackPanel Orientation="Horizontal">
                                <ui:SymbolIcon Symbol="Delete24" FontSize="16" Margin="0,0,8,0" />
                                <TextBlock Text="Remove Selected" VerticalAlignment="Center" />
                            </StackPanel>
                        </ui:Button>

                        <!-- Disconnect -->
                        <ui:Button Command="{Binding DisconnectNodesCommand}"
                                  HorizontalAlignment="Stretch"
                                  Appearance="Secondary"
                                  Margin="0,0,0,8"
                                  Padding="8">
                            <StackPanel Orientation="Horizontal">
                                <ui:SymbolIcon Symbol="PlugDisconnected24" FontSize="16" Margin="0,0,8,0" />
                                <TextBlock Text="Disconnect" VerticalAlignment="Center" />
                            </StackPanel>
                        </ui:Button>
                    </StackPanel>
                </ScrollViewer>
            </Border>

            <!-- Center Column - Canvas Area with drag-and-drop support -->
            <Border Grid.Column="1"
                    Background="#05000000"
                    BorderBrush="#20FFFFFF"
                    BorderThickness="0,0,1,0">
                <Grid>
                    <!-- Interactive canvas for visual tunnel builder with drag-and-drop -->
                    <controls:TunnelCanvas DataContext="{Binding}" />

                    <!-- Empty State -->
                    <TextBlock Text="Add nodes from the palette on the left to start building your tunnel. Drag nodes to reposition them."
                              FontSize="14"
                              Opacity="0.5"
                              HorizontalAlignment="Center"
                              VerticalAlignment="Center"
                              TextWrapping="Wrap"
                              TextAlignment="Center"
                              MaxWidth="300"
                              IsHitTestVisible="False"
                              Visibility="{Binding Nodes.Count, Converter={StaticResource CountToVisibilityConverter}, ConverterParameter=invert}" />
                </Grid>
            </Border>

            <!-- Right Column - Properties Panel -->
            <Border Grid.Column="2"
                    Background="#0D000000"
                    BorderBrush="#20FFFFFF"
                    BorderThickness="0"
                    Padding="12">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <!-- Profile Settings -->
                        <TextBlock Text="Profile Settings"
                                  FontWeight="SemiBold"
                                  FontSize="14"
                                  Margin="0,0,0,8" />

                        <!-- Display Name -->
                        <TextBlock Text="Display Name"
                                  FontWeight="SemiBold"
                                  Margin="0,0,0,4" />
                        <ui:TextBox Text="{Binding DisplayName, UpdateSourceTrigger=PropertyChanged}"
                                   PlaceholderText="My SSH Tunnel"
                                   Margin="0,0,0,12" />

                        <!-- Description -->
                        <TextBlock Text="Description"
                                  FontWeight="SemiBold"
                                  Margin="0,0,0,4" />
                        <ui:TextBox Text="{Binding Description, UpdateSourceTrigger=PropertyChanged}"
                                   PlaceholderText="Optional description..."
                                   AcceptsReturn="True"
                                   TextWrapping="Wrap"
                                   MinHeight="60"
                                   MaxHeight="100"
                                   Margin="0,0,0,16" />

                        <!-- Selected Node Properties -->
                        <Border Visibility="{Binding SelectedNode, Converter={StaticResource NullToVisibilityConverter}}"
                               Background="#1FFFFFFF"
                               BorderBrush="#2FFFFFFF"
                               BorderThickness="1"
                               CornerRadius="6"
                               Padding="12"
                               Margin="0,0,0,16">
                            <StackPanel>
                                <TextBlock Text="Selected Node Properties"
                                          FontWeight="SemiBold"
                                          FontSize="14"
                                          Margin="0,0,0,12" />

                                <!-- Label -->
                                <TextBlock Text="Label"
                                          FontWeight="SemiBold"
                                          Margin="0,0,0,4" />
                                <ui:TextBox Text="{Binding SelectedNode.Label, UpdateSourceTrigger=PropertyChanged}"
                                           PlaceholderText="Node label"
                                           Margin="0,0,0,12" />

                                <!-- Host Selector (for SshHost nodes) -->
                                <StackPanel Visibility="{Binding SelectedNode.NodeType, ConverterParameter={x:Static models:TunnelNodeType.SshHost}, Converter={StaticResource EqualityToVisibilityConverter}}">
                                    <TextBlock Text="SSH Host"
                                              FontWeight="SemiBold"
                                              Margin="0,0,0,4" />
                                    <ComboBox ItemsSource="{Binding AvailableHosts}"
                                             SelectedItem="{Binding SelectedNode.SelectedHost}"
                                             Margin="0,0,0,12">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                <StackPanel Orientation="Horizontal">
                                                    <ui:SymbolIcon Symbol="Server24" FontSize="14" Margin="0,0,6,0" />
                                                    <TextBlock Text="{Binding DisplayName}" />
                                                </StackPanel>
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>
                                </StackPanel>

                                <!-- Local Port Forward (-L local_port:remote_host:remote_port) -->
                                <StackPanel Visibility="{Binding SelectedNode.NodeType, ConverterParameter={x:Static models:TunnelNodeType.LocalPort}, Converter={StaticResource EqualityToVisibilityConverter}}">
                                    <TextBlock Text="Local Port"
                                              FontWeight="SemiBold"
                                              Margin="0,0,0,4" />
                                    <ui:NumberBox Value="{Binding SelectedNode.LocalPort}"
                                                 Minimum="1"
                                                 Maximum="65535"
                                                 SpinButtonPlacementMode="Compact"
                                                 PlaceholderText="8080"
                                                 Margin="0,0,0,8" />
                                    <TextBlock Text="Port to listen on locally"
                                              FontSize="11"
                                              Opacity="0.6"
                                              Margin="0,0,0,12" />

                                    <TextBlock Text="Target Host"
                                              FontWeight="SemiBold"
                                              Margin="0,0,0,4" />
                                    <ui:TextBox Text="{Binding SelectedNode.RemoteHost, UpdateSourceTrigger=PropertyChanged}"
                                               PlaceholderText="localhost"
                                               Margin="0,0,0,8" />
                                    <TextBlock Text="Host to forward traffic to"
                                              FontSize="11"
                                              Opacity="0.6"
                                              Margin="0,0,0,12" />

                                    <TextBlock Text="Target Port"
                                              FontWeight="SemiBold"
                                              Margin="0,0,0,4" />
                                    <ui:NumberBox Value="{Binding SelectedNode.RemotePort}"
                                                 Minimum="1"
                                                 Maximum="65535"
                                                 SpinButtonPlacementMode="Compact"
                                                 PlaceholderText="80"
                                                 Margin="0,0,0,8" />
                                    <TextBlock Text="Port on target host"
                                              FontSize="11"
                                              Opacity="0.6"
                                              Margin="0,0,0,12" />
                                </StackPanel>

                                <!-- Remote Port Forward (-R remote_port:local_host:local_port) -->
                                <StackPanel Visibility="{Binding SelectedNode.NodeType, ConverterParameter={x:Static models:TunnelNodeType.RemotePort}, Converter={StaticResource EqualityToVisibilityConverter}}">
                                    <TextBlock Text="Remote Port"
                                              FontWeight="SemiBold"
                                              Margin="0,0,0,4" />
                                    <ui:NumberBox Value="{Binding SelectedNode.RemotePort}"
                                                 Minimum="1"
                                                 Maximum="65535"
                                                 SpinButtonPlacementMode="Compact"
                                                 PlaceholderText="8080"
                                                 Margin="0,0,0,8" />
                                    <TextBlock Text="Port to listen on the SSH server"
                                              FontSize="11"
                                              Opacity="0.6"
                                              Margin="0,0,0,12" />

                                    <TextBlock Text="Target Host"
                                              FontWeight="SemiBold"
                                              Margin="0,0,0,4" />
                                    <ui:TextBox Text="{Binding SelectedNode.RemoteHost, UpdateSourceTrigger=PropertyChanged}"
                                               PlaceholderText="localhost"
                                               Margin="0,0,0,8" />
                                    <TextBlock Text="Host to forward traffic to (from server)"
                                              FontSize="11"
                                              Opacity="0.6"
                                              Margin="0,0,0,12" />

                                    <TextBlock Text="Target Port"
                                              FontWeight="SemiBold"
                                              Margin="0,0,0,4" />
                                    <ui:NumberBox Value="{Binding SelectedNode.LocalPort}"
                                                 Minimum="1"
                                                 Maximum="65535"
                                                 SpinButtonPlacementMode="Compact"
                                                 PlaceholderText="80"
                                                 Margin="0,0,0,8" />
                                    <TextBlock Text="Port on target host"
                                              FontSize="11"
                                              Opacity="0.6"
                                              Margin="0,0,0,12" />
                                </StackPanel>

                                <!-- Dynamic Proxy / SOCKS (-D local_port) -->
                                <StackPanel Visibility="{Binding SelectedNode.NodeType, ConverterParameter={x:Static models:TunnelNodeType.DynamicProxy}, Converter={StaticResource EqualityToVisibilityConverter}}">
                                    <TextBlock Text="SOCKS Port"
                                              FontWeight="SemiBold"
                                              Margin="0,0,0,4" />
                                    <ui:NumberBox Value="{Binding SelectedNode.LocalPort}"
                                                 Minimum="1"
                                                 Maximum="65535"
                                                 SpinButtonPlacementMode="Compact"
                                                 PlaceholderText="1080"
                                                 Margin="0,0,0,8" />
                                    <TextBlock Text="Local port for SOCKS proxy"
                                              FontSize="11"
                                              Opacity="0.6"
                                              Margin="0,0,0,12" />
                                </StackPanel>

                                <!-- Target Host (destination in tunnel chain) -->
                                <StackPanel Visibility="{Binding SelectedNode.NodeType, ConverterParameter={x:Static models:TunnelNodeType.TargetHost}, Converter={StaticResource EqualityToVisibilityConverter}}">
                                    <TextBlock Text="Target Host"
                                              FontWeight="SemiBold"
                                              Margin="0,0,0,4" />
                                    <ui:TextBox Text="{Binding SelectedNode.RemoteHost, UpdateSourceTrigger=PropertyChanged}"
                                               PlaceholderText="192.168.1.100"
                                               Margin="0,0,0,8" />
                                    <TextBlock Text="Hostname or IP of the target"
                                              FontSize="11"
                                              Opacity="0.6"
                                              Margin="0,0,0,12" />

                                    <TextBlock Text="Target Port"
                                              FontWeight="SemiBold"
                                              Margin="0,0,0,4" />
                                    <ui:NumberBox Value="{Binding SelectedNode.RemotePort}"
                                                 Minimum="1"
                                                 Maximum="65535"
                                                 SpinButtonPlacementMode="Compact"
                                                 PlaceholderText="22"
                                                 Margin="0,0,0,8" />
                                    <TextBlock Text="Port on the target host"
                                              FontSize="11"
                                              Opacity="0.6"
                                              Margin="0,0,0,12" />
                                </StackPanel>

                                <!-- Bind Address -->
                                <TextBlock Text="Bind Address"
                                          FontWeight="SemiBold"
                                          Margin="0,0,0,4" />
                                <ui:TextBox Text="{Binding SelectedNode.BindAddress, UpdateSourceTrigger=PropertyChanged}"
                                           PlaceholderText="localhost"
                                           Margin="0,0,0,4" />
                                <TextBlock Text="Address to bind to (typically localhost)"
                                          FontSize="11"
                                          Opacity="0.6"
                                          TextWrapping="Wrap" />
                            </StackPanel>
                        </Border>

                        <!-- Command Preview -->
                        <TextBlock Text="Command Preview"
                                  FontWeight="SemiBold"
                                  FontSize="14"
                                  Margin="0,0,0,8" />

                        <!-- Validation Errors -->
                        <Border Visibility="{Binding ValidationError, Converter={StaticResource StringToVisibilityConverter}}"
                               Background="#20E74C3C"
                               BorderBrush="#40E74C3C"
                               BorderThickness="1"
                               CornerRadius="4"
                               Padding="8"
                               Margin="0,0,0,8">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>
                                <ui:SymbolIcon Grid.Column="0"
                                              Symbol="Warning24"
                                              FontSize="14"
                                              Foreground="#E74C3C"
                                              Margin="0,2,8,0"
                                              VerticalAlignment="Top" />
                                <TextBlock Grid.Column="1"
                                          Text="{Binding ValidationError}"
                                          TextWrapping="Wrap"
                                          Foreground="#E74C3C"
                                          FontSize="12" />
                            </Grid>
                        </Border>

                        <!-- Command Text -->
                        <Border Background="#1FFFFFFF"
                               BorderBrush="#2FFFFFFF"
                               BorderThickness="1"
                               CornerRadius="6"
                               Padding="8"
                               Margin="0,0,0,8"
                               MinHeight="80">
                            <ScrollViewer VerticalScrollBarVisibility="Auto"
                                         HorizontalScrollBarVisibility="Auto">
                                <TextBlock Text="{Binding CommandPreview}"
                                          FontFamily="Consolas"
                                          FontSize="11"
                                          TextWrapping="NoWrap" />
                            </ScrollViewer>
                        </Border>

                        <!-- Copy hint -->
                        <TextBlock Text="Tip: Use 'Copy Command' to copy the full command"
                                  FontSize="10"
                                  Opacity="0.5"
                                  Margin="0,0,0,8" />
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>

        <!-- Bottom Row - Action Buttons -->
        <Grid Grid.Row="2"
              Margin="24,16"
              Background="{DynamicResource ApplicationBackgroundBrush}"
              Height="48">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <!-- Copy Command -->
            <ui:Button Grid.Column="1"
                      Icon="{ui:SymbolIcon Copy24}"
                      Content="Copy Command"
                      Command="{Binding CopyCommandCommand}"
                      Margin="0,0,8,0"
                      MinWidth="120" />

            <!-- Validate -->
            <ui:Button Grid.Column="2"
                      Icon="{ui:SymbolIcon CheckmarkCircle24}"
                      Content="Validate"
                      Command="{Binding ValidateAsyncCommand}"
                      Margin="0,0,8,0"
                      MinWidth="100" />

            <!-- Execute -->
            <ui:Button Grid.Column="3"
                      Icon="{ui:SymbolIcon Play24}"
                      Content="Execute"
                      Appearance="Primary"
                      Command="{Binding ExecuteAsyncCommand}"
                      IsEnabled="{Binding IsValid}"
                      Margin="0,0,8,0"
                      MinWidth="100" />

            <!-- Save -->
            <ui:Button Grid.Column="4"
                      Icon="{ui:SymbolIcon Save24}"
                      Content="Save"
                      Command="{Binding SaveAsyncCommand}"
                      Margin="0,0,8,0"
                      MinWidth="100" />

            <!-- Close -->
            <ui:Button Grid.Column="5"
                      Content="Close"
                      Click="CloseButton_Click"
                      MinWidth="80" />
        </Grid>
    </Grid>
</ui:FluentWindow>
