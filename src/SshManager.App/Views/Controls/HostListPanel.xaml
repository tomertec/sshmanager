<UserControl x:Class="SshManager.App.Views.Controls.HostListPanel"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             xmlns:system="clr-namespace:System;assembly=System.Runtime"
             xmlns:converters="clr-namespace:SshManager.App.Converters"
             xmlns:behaviors="clr-namespace:SshManager.App.Behaviors"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="280"
             Background="{ui:ThemeResource ApplicationBackgroundBrush}">

    <UserControl.Resources>
        <!-- Binding proxy for context menus (which exist outside the visual tree) -->
        <converters:BindingProxy x:Key="ViewModelProxy" Data="{Binding}" />

        <!-- Easing functions for animations -->
        <CubicEase x:Key="EaseOut" EasingMode="EaseOut" />

        <!-- Pulsing Status Dot Style -->
        <Style x:Key="PulsingStatusDot" TargetType="Ellipse">
            <Style.Triggers>
                <DataTrigger Value="True">
                    <DataTrigger.Binding>
                        <MultiBinding Converter="{StaticResource HostHasActiveSessionConverter}">
                            <Binding Path="Id" />
                            <Binding Path="DataContext.Sessions" RelativeSource="{RelativeSource AncestorType=ListBox}" />
                        </MultiBinding>
                    </DataTrigger.Binding>
                    <DataTrigger.EnterActions>
                        <BeginStoryboard>
                            <Storyboard RepeatBehavior="Forever">
                                <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                 From="1" To="0.4" Duration="0:0:1"
                                                 AutoReverse="True"
                                                 EasingFunction="{StaticResource EaseOut}"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </DataTrigger.EnterActions>
                    <DataTrigger.ExitActions>
                        <BeginStoryboard>
                            <Storyboard>
                                <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                 To="1" Duration="0:0:0.2"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </DataTrigger.ExitActions>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <!-- Skeleton Loading Template for Host List -->
        <DataTemplate x:Key="HostSkeletonTemplate">
            <Border Background="#08FFFFFF" CornerRadius="8" Padding="12" Margin="4,2">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <Ellipse Grid.Column="0" Width="10" Height="10" Fill="#15FFFFFF" Margin="0,0,10,0" VerticalAlignment="Center" />

                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                        <Border Width="120" Height="14" Background="#15FFFFFF" CornerRadius="4">
                            <Border.Style>
                                <Style TargetType="Border">
                                    <Style.Triggers>
                                        <EventTrigger RoutedEvent="Loaded">
                                            <BeginStoryboard>
                                                <Storyboard RepeatBehavior="Forever">
                                                    <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                     From="0.3" To="0.6" Duration="0:0:0.8"
                                                                     AutoReverse="True" />
                                                </Storyboard>
                                            </BeginStoryboard>
                                        </EventTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>
                        </Border>
                        <Border Width="80" Height="10" Background="#10FFFFFF" CornerRadius="4" Margin="0,6,0,0">
                            <Border.Style>
                                <Style TargetType="Border">
                                    <Style.Triggers>
                                        <EventTrigger RoutedEvent="Loaded">
                                            <BeginStoryboard>
                                                <Storyboard RepeatBehavior="Forever">
                                                    <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                     From="0.3" To="0.6" Duration="0:0:0.8"
                                                                     AutoReverse="True">
                                                        <DoubleAnimation.BeginTime>0:0:0.1</DoubleAnimation.BeginTime>
                                                    </DoubleAnimation>
                                                </Storyboard>
                                            </BeginStoryboard>
                                        </EventTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>
                        </Border>
                    </StackPanel>
                </Grid>
            </Border>
        </DataTemplate>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Search Box with Settings Button -->
        <Grid Grid.Row="0" Margin="8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>
            <ui:TextBox x:Name="SearchBox"
                       Grid.Column="0"
                       PlaceholderText="Search hosts... (Ctrl+F)"
                       Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                       Icon="{ui:SymbolIcon Search24}" />
            <ui:Button Grid.Column="1"
                      Icon="{ui:SymbolIcon Settings24}"
                      ToolTip="Settings (Ctrl+,)"
                      Click="SettingsButton_Click"
                      Padding="8,6"
                      Margin="4,0,0,0" />
        </Grid>

        <!-- Tag Filter Section -->
        <Border Grid.Row="1"
                Margin="8,0,8,8"
                Background="#0C000000"
                BorderBrush="#1AFFFFFF"
                BorderThickness="1"
                CornerRadius="6"
                Padding="8,6"
                Visibility="{Binding AllTags.Count, Converter={StaticResource NullToBoolConverter}, ConverterParameter=Inverse, FallbackValue=Collapsed}">
            <StackPanel>
                <!-- Selected Filter Tags (with remove buttons) -->
                <ItemsControl ItemsSource="{Binding SelectedFilterTags}"
                             Visibility="{Binding SelectedFilterTags.Count, Converter={StaticResource NullToBoolConverter}, FallbackValue=Collapsed}"
                             Margin="0,0,0,4">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel Orientation="Horizontal" />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <!-- Selected tag chip with X button -->
                            <Border Background="#3F0078D4"
                                   BorderBrush="#0078D4"
                                   BorderThickness="1"
                                   CornerRadius="10"
                                   Padding="8,3"
                                   Margin="0,0,4,4">
                                <StackPanel Orientation="Horizontal">
                                    <ui:SymbolIcon Symbol="Tag16"
                                                  FontSize="10"
                                                  Margin="0,0,4,0"
                                                  VerticalAlignment="Center"
                                                  Foreground="#0078D4" />
                                    <TextBlock Text="{Binding Name}"
                                              FontSize="11"
                                              VerticalAlignment="Center"
                                              Foreground="#FFFFFF" />
                                    <ui:Button Icon="{ui:SymbolIcon Dismiss12}"
                                              Command="{Binding DataContext.ToggleTagFilterCommand, RelativeSource={RelativeSource AncestorType=Border, AncestorLevel=3}}"
                                              CommandParameter="{Binding}"
                                              Width="16" Height="16"
                                              Padding="0"
                                              Margin="4,0,0,0"
                                              Background="Transparent"
                                              ToolTip="Remove tag filter" />
                                </StackPanel>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <!-- Available Tags (clickable chips) -->
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Column="0"
                              Text="Tags:"
                              FontSize="11"
                              Opacity="0.6"
                              VerticalAlignment="Center"
                              Margin="0,0,6,0" />

                    <ItemsControl Grid.Column="1"
                                 ItemsSource="{Binding AllTags}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal" />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <!-- Tag chip -->
                                <Border x:Name="TagChip"
                                       Background="#1AFFFFFF"
                                       BorderBrush="#2AFFFFFF"
                                       BorderThickness="1"
                                       CornerRadius="10"
                                       Padding="8,3"
                                       Margin="0,0,4,4"
                                       Cursor="Hand"
                                       ToolTip="Click to filter by this tag">
                                    <Border.InputBindings>
                                        <MouseBinding MouseAction="LeftClick"
                                                    Command="{Binding DataContext.ToggleTagFilterCommand, RelativeSource={RelativeSource AncestorType=Border, AncestorLevel=4}}"
                                                    CommandParameter="{Binding}" />
                                    </Border.InputBindings>
                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <Style.Triggers>
                                                <!-- Highlight when hovered -->
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="Background" Value="#2AFFFFFF" />
                                                    <Setter Property="BorderBrush" Value="#3FFFFFFF" />
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                    <StackPanel Orientation="Horizontal">
                                        <ui:SymbolIcon Symbol="Tag16"
                                                      FontSize="10"
                                                      Margin="0,0,4,0"
                                                      VerticalAlignment="Center"
                                                      Opacity="0.7" />
                                        <TextBlock Text="{Binding Name}"
                                                  FontSize="11"
                                                  VerticalAlignment="Center"
                                                  Opacity="0.8" />
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </Grid>
            </StackPanel>
        </Border>

        <!-- Groups Section - Compact Filter Bar -->
        <Grid Grid.Row="2" Margin="8,4,8,8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <!-- Group Filter Dropdown with Management Options -->
            <ui:DropDownButton x:Name="GroupFilterDropdown"
                              Grid.Column="0"
                              MinWidth="90"
                              MaxWidth="140"
                              Padding="6,6,8,6"
                              HorizontalContentAlignment="Left"
                              VerticalAlignment="Center">
                <ui:DropDownButton.Content>
                    <StackPanel Orientation="Horizontal" Margin="-2,0,0,0">
                        <!-- Color indicator circle (for selected group with colors) -->
                        <Ellipse Width="10" Height="10"
                                Margin="0,0,5,0"
                                VerticalAlignment="Center"
                                Visibility="{Binding SelectedGroupFilter.Color, Converter={StaticResource GroupColorToVisibilityConverter}}">
                            <Ellipse.Fill>
                                <Binding Path="SelectedGroupFilter.Color" Converter="{StaticResource GroupColorConverter}" />
                            </Ellipse.Fill>
                        </Ellipse>
                        <ui:SymbolIcon Symbol="Grid24" Margin="0,0,6,0" FontSize="14" />
                        <TextBlock x:Name="GroupFilterText" Text="All Groups" VerticalAlignment="Center" />
                    </StackPanel>
                </ui:DropDownButton.Content>
                <ui:DropDownButton.Flyout>
                    <ContextMenu x:Name="GroupFilterMenu" MinWidth="200">
                        <!-- Group Management Section -->
                        <ui:MenuItem Header="Add New Group"
                                    Icon="{ui:SymbolIcon Add16}"
                                    Command="{Binding AddGroupCommand}" />
                        <ui:MenuItem Header="Edit Selected Group"
                                    Icon="{ui:SymbolIcon Edit16}"
                                    Command="{Binding EditGroupCommand}"
                                    CommandParameter="{Binding SelectedGroupFilter}"
                                    IsEnabled="{Binding SelectedGroupFilter, Converter={StaticResource NullToBoolConverter}}" />
                        <ui:MenuItem Header="Delete Selected Group"
                                    Icon="{ui:SymbolIcon Delete16}"
                                    Command="{Binding DeleteGroupCommand}"
                                    CommandParameter="{Binding SelectedGroupFilter}"
                                    IsEnabled="{Binding SelectedGroupFilter, Converter={StaticResource NullToBoolConverter}}" />
                        <Separator />
                        <!-- Groups list will be populated in code-behind -->
                    </ContextMenu>
                </ui:DropDownButton.Flyout>
            </ui:DropDownButton>

            <!-- Action Buttons: Quick Connect, Add Host, Help -->
            <StackPanel Grid.Column="2"
                       Orientation="Horizontal"
                       VerticalAlignment="Center">
                <!-- Quick Connect Overlay Button (Ctrl+K) -->
                <ui:Button Icon="{ui:SymbolIcon Search24}"
                          ToolTip="Quick Connect (Ctrl+K)"
                          Click="QuickConnectOverlayButton_Click"
                          Padding="8,6"
                          Margin="0,0,4,0" />
                <!-- Add Host Button -->
                <ui:Button Icon="{ui:SymbolIcon Add24}"
                          ToolTip="Add Host (Ctrl+N)"
                          Command="{Binding AddHostCommand}"
                          Padding="8,6"
                          Margin="0,0,4,0" />
                <!-- Help Button -->
                <ui:DropDownButton Icon="{ui:SymbolIcon QuestionCircle24}"
                                  ToolTip="Help"
                                  Padding="8,6">
                    <ui:DropDownButton.Flyout>
                        <ContextMenu>
                            <ui:MenuItem Header="Keyboard Shortcuts"
                                        Icon="{ui:SymbolIcon Keyboard24}"
                                        Click="KeyboardShortcutsMenuItem_Click" />
                            <Separator />
                            <ui:MenuItem Header="About SSH Manager"
                                        Icon="{ui:SymbolIcon Info24}"
                                        Click="AboutMenuItem_Click" />
                        </ContextMenu>
                    </ui:DropDownButton.Flyout>
                </ui:DropDownButton>
            </StackPanel>
        </Grid>

        <!-- Host List (with skeleton loading and empty state) -->
        <Grid Grid.Row="3">
            <!-- Skeleton Loading State -->
            <ItemsControl Visibility="{Binding IsLoadingHosts, Converter={StaticResource BoolToVisibilityConverter}}"
                         Margin="8,8,8,0">
                <ItemsControl.ItemTemplate>
                    <StaticResource ResourceKey="HostSkeletonTemplate" />
                </ItemsControl.ItemTemplate>
                <ItemsControl.Items>
                    <system:Int32>1</system:Int32>
                    <system:Int32>2</system:Int32>
                    <system:Int32>3</system:Int32>
                    <system:Int32>4</system:Int32>
                    <system:Int32>5</system:Int32>
                </ItemsControl.Items>
            </ItemsControl>

            <!-- Empty State (when no hosts and not loading) -->
            <StackPanel Visibility="{Binding HasNoHosts, Converter={StaticResource BoolToVisibilityConverter}}"
                        HorizontalAlignment="Center" VerticalAlignment="Center"
                        Margin="20">
                <ui:SymbolIcon Symbol="DesktopSignal24" FontSize="48" Opacity="0.2"/>
                <TextBlock Text="No hosts yet"
                           FontSize="18" FontWeight="SemiBold"
                           HorizontalAlignment="Center"
                           Opacity="0.7" Margin="0,16,0,4"/>
                <TextBlock Text="Add your first SSH connection to get started"
                           FontSize="12"
                           HorizontalAlignment="Center"
                           Opacity="0.4" TextWrapping="Wrap" TextAlignment="Center"
                           MaxWidth="200"/>
                <Button Command="{Binding AddHostCommand}"
                        Padding="16,10"
                        FontSize="14"
                        Margin="0,20,0,0"
                        HorizontalAlignment="Center"
                        Cursor="Hand">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="Button">
                                        <Border x:Name="ButtonBorder"
                                                Background="#286fe0"
                                                CornerRadius="8"
                                                Padding="{TemplateBinding Padding}">
                                            <TextBlock Text="Add Host" Foreground="White" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="ButtonBorder" Property="Background" Value="#3a7de8"/>
                                            </Trigger>
                                            <Trigger Property="IsPressed" Value="True">
                                                <Setter TargetName="ButtonBorder" Property="Background" Value="#1e5bb8"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </Button.Style>
                </Button>
            </StackPanel>

            <!-- Actual Host List -->
            <ListBox x:Name="HostListBox"
                     ItemsSource="{Binding Hosts}"
                     SelectedItem="{Binding SelectedHost}"
                     Margin="8,8,8,0"
                     Background="Transparent"
                     BorderThickness="0"
                     ScrollViewer.VerticalScrollBarVisibility="Auto"
                     VirtualizingPanel.IsVirtualizing="True"
                     VirtualizingPanel.VirtualizationMode="Recycling"
                     VirtualizingPanel.ScrollUnit="Pixel"
                     VirtualizingPanel.CacheLength="20,20"
                     VirtualizingPanel.CacheLengthUnit="Item"
                     behaviors:ListBoxDragDropBehavior.IsEnabled="True"
                     behaviors:ListBoxDragDropBehavior.ReorderCommand="{Binding ReorderHostsCommand}"
                     Visibility="{Binding HasNoHosts, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                <ListBox.ItemContainerStyle>
                <Style TargetType="ListBoxItem">
                    <Setter Property="Padding" Value="0" />
                    <Setter Property="Margin" Value="0,0,12,8" />
                    <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                    <Setter Property="Background" Value="Transparent" />
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="ListBoxItem">
                                <ContentPresenter />
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>
            </ListBox.ItemContainerStyle>
            <ListBox.ItemTemplate>
                <DataTemplate>
                    <!-- Outer border for active session indicator -->
                    <Border CornerRadius="8"
                           BorderThickness="2"
                           Padding="0">
                        <Border.ContextMenu>
                            <ContextMenu>
                                <ui:MenuItem Header="Connect"
                                            Icon="{ui:SymbolIcon Play16}"
                                            Command="{Binding Data.ConnectCommand, Source={StaticResource ViewModelProxy}}"
                                            CommandParameter="{Binding}"
                                            FontWeight="SemiBold"
                                            IsEnabled="{Binding Data.IsConnecting, Source={StaticResource ViewModelProxy}, Converter={StaticResource InverseBoolConverter}}" />
                                <ui:MenuItem Command="{Binding Data.ToggleFavoriteCommand, Source={StaticResource ViewModelProxy}}"
                                            CommandParameter="{Binding}">
                                    <ui:MenuItem.Style>
                                        <Style TargetType="ui:MenuItem">
                                            <Setter Property="Header" Value="Add to Favorites" />
                                            <Setter Property="Icon" Value="{ui:SymbolIcon Star16}" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsFavorite}" Value="True">
                                                    <Setter Property="Header" Value="Remove from Favorites" />
                                                    <Setter Property="Icon" Value="{ui:SymbolIcon StarOff16}" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </ui:MenuItem.Style>
                                </ui:MenuItem>
                                <Separator />
                                <ui:MenuItem Header="Copy Hostname"
                                            Icon="{ui:SymbolIcon Copy16}"
                                            Command="{Binding Data.CopyHostnameCommand, Source={StaticResource ViewModelProxy}}"
                                            CommandParameter="{Binding}" />
                                <ui:MenuItem Header="Copy IP Address"
                                            Icon="{ui:SymbolIcon Globe16}"
                                            Command="{Binding Data.CopyIpAddressCommand, Source={StaticResource ViewModelProxy}}"
                                            CommandParameter="{Binding}" />
                                <Separator />
                                <ui:MenuItem Header="Duplicate Host"
                                            Icon="{ui:SymbolIcon DocumentCopy16}"
                                            Command="{Binding Data.DuplicateHostCommand, Source={StaticResource ViewModelProxy}}"
                                            CommandParameter="{Binding}" />
                                <ui:MenuItem Header="Edit"
                                            Icon="{ui:SymbolIcon Edit16}"
                                            Command="{Binding Data.EditHostCommand, Source={StaticResource ViewModelProxy}}"
                                            CommandParameter="{Binding}" />
                                <ui:MenuItem Header="SFTP Browser"
                                            Icon="{ui:SymbolIcon FolderOpen16}"
                                            Command="{Binding Data.OpenSftpBrowserForHostCommand, Source={StaticResource ViewModelProxy}}"
                                            CommandParameter="{Binding}" />
                                <Separator />
                                <ui:MenuItem Header="Delete"
                                            Icon="{ui:SymbolIcon Delete16}"
                                            Command="{Binding Data.DeleteHostCommand, Source={StaticResource ViewModelProxy}}"
                                            CommandParameter="{Binding}" />
                            </ContextMenu>
                        </Border.ContextMenu>
                        <Border.BorderBrush>
                            <MultiBinding Converter="{StaticResource HostActiveSessionBorderConverter}">
                                <Binding Path="Id" />
                                <Binding Path="DataContext.Sessions" RelativeSource="{RelativeSource AncestorType=ListBox}" />
                            </MultiBinding>
                        </Border.BorderBrush>
                    <Grid>
                        <!-- Colored left stripe for group color -->
                        <Border Width="4"
                               HorizontalAlignment="Left"
                               CornerRadius="6,0,0,6"
                               Visibility="{Binding Group.Color, Converter={StaticResource GroupColorToVisibilityConverter}}">
                            <Border.Background>
                                <Binding Path="Group.Color" Converter="{StaticResource GroupColorConverter}" />
                            </Border.Background>
                        </Border>
                    <Border x:Name="CardBorder"
                           CornerRadius="6"
                           Background="#1FFFFFFF"
                           BorderBrush="#2FFFFFFF"
                           BorderThickness="1"
                           Padding="8,6"
                           RenderTransformOrigin="0.5,0.5">
                        <Border.RenderTransform>
                            <TransformGroup>
                                <ScaleTransform ScaleX="1" ScaleY="1" />
                                <TranslateTransform X="0" Y="0" />
                            </TransformGroup>
                        </Border.RenderTransform>
                        <Border.Style>
                            <Style TargetType="Border">
                                <Style.Triggers>
                                    <EventTrigger RoutedEvent="Loaded">
                                        <BeginStoryboard>
                                            <Storyboard>
                                                <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                From="0" To="1"
                                                                Duration="0:0:0.3">
                                                    <DoubleAnimation.EasingFunction>
                                                        <CubicEase EasingMode="EaseOut" />
                                                    </DoubleAnimation.EasingFunction>
                                                </DoubleAnimation>
                                                <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[1].(TranslateTransform.Y)"
                                                                From="20" To="0"
                                                                Duration="0:0:0.3">
                                                    <DoubleAnimation.EasingFunction>
                                                        <CubicEase EasingMode="EaseOut" />
                                                    </DoubleAnimation.EasingFunction>
                                                </DoubleAnimation>
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </EventTrigger>
                                    <EventTrigger RoutedEvent="MouseEnter">
                                        <BeginStoryboard>
                                            <Storyboard>
                                                <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[0].(ScaleTransform.ScaleX)"
                                                                To="1.02" Duration="0:0:0.15">
                                                    <DoubleAnimation.EasingFunction>
                                                        <QuadraticEase EasingMode="EaseOut" />
                                                    </DoubleAnimation.EasingFunction>
                                                </DoubleAnimation>
                                                <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[0].(ScaleTransform.ScaleY)"
                                                                To="1.02" Duration="0:0:0.15">
                                                    <DoubleAnimation.EasingFunction>
                                                        <QuadraticEase EasingMode="EaseOut" />
                                                    </DoubleAnimation.EasingFunction>
                                                </DoubleAnimation>
                                                <ColorAnimation Storyboard.TargetProperty="(Border.Background).(SolidColorBrush.Color)"
                                                               To="#2AFFFFFF" Duration="0:0:0.15" />
                                                <ColorAnimation Storyboard.TargetProperty="(Border.BorderBrush).(SolidColorBrush.Color)"
                                                               To="#3FFFFFFF" Duration="0:0:0.15" />
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </EventTrigger>
                                    <EventTrigger RoutedEvent="MouseLeave">
                                        <BeginStoryboard>
                                            <Storyboard>
                                                <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[0].(ScaleTransform.ScaleX)"
                                                                To="1" Duration="0:0:0.2">
                                                    <DoubleAnimation.EasingFunction>
                                                        <QuadraticEase EasingMode="EaseOut" />
                                                    </DoubleAnimation.EasingFunction>
                                                </DoubleAnimation>
                                                <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[0].(ScaleTransform.ScaleY)"
                                                                To="1" Duration="0:0:0.2">
                                                    <DoubleAnimation.EasingFunction>
                                                        <QuadraticEase EasingMode="EaseOut" />
                                                    </DoubleAnimation.EasingFunction>
                                                </DoubleAnimation>
                                                <ColorAnimation Storyboard.TargetProperty="(Border.Background).(SolidColorBrush.Color)"
                                                               To="#1FFFFFFF" Duration="0:0:0.2" />
                                                <ColorAnimation Storyboard.TargetProperty="(Border.BorderBrush).(SolidColorBrush.Color)"
                                                               To="#2FFFFFFF" Duration="0:0:0.2" />
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </EventTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <!-- Status Indicator Dot -->
                            <Ellipse Grid.Row="0" Grid.RowSpan="2"
                                    Grid.Column="0"
                                    Width="10" Height="10"
                                    Margin="0,0,10,0"
                                    VerticalAlignment="Center"
                                    Style="{StaticResource PulsingStatusDot}">
                                <Ellipse.ToolTip>
                                    <MultiBinding Converter="{StaticResource HostStatusToTooltipConverter}">
                                        <Binding Path="Id" />
                                        <Binding Path="DataContext.HostStatuses" RelativeSource="{RelativeSource AncestorType=ListBox}" />
                                    </MultiBinding>
                                </Ellipse.ToolTip>
                                <Ellipse.Fill>
                                    <MultiBinding Converter="{StaticResource HostStatusToColorConverter}">
                                        <Binding Path="Id" />
                                        <Binding Path="DataContext.HostStatuses" RelativeSource="{RelativeSource AncestorType=ListBox}" />
                                    </MultiBinding>
                                </Ellipse.Fill>
                            </Ellipse>

                            <!-- Row 1: Name and Action Buttons -->
                            <TextBlock Grid.Row="0" Grid.Column="1"
                                      Text="{Binding DisplayName}"
                                      FontWeight="SemiBold"
                                      FontSize="13"
                                      VerticalAlignment="Center"
                                      TextTrimming="CharacterEllipsis" />

                            <StackPanel Grid.Row="0" Grid.Column="2"
                                       Orientation="Horizontal"
                                       VerticalAlignment="Center"
                                       Margin="4,0,0,0">
                                <!-- Favorite toggle button -->
                                <ui:Button Command="{Binding DataContext.ToggleFavoriteCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                          CommandParameter="{Binding}"
                                          Width="24" Height="24"
                                          Padding="0"
                                          CornerRadius="4"
                                          Margin="0,0,2,0">
                                    <ui:Button.Style>
                                        <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                                            <Setter Property="Background" Value="Transparent" />
                                            <Setter Property="BorderThickness" Value="0" />
                                            <Setter Property="ToolTip" Value="Add to Favorites" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsFavorite}" Value="True">
                                                    <Setter Property="ToolTip" Value="Remove from Favorites" />
                                                </DataTrigger>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="Background" Value="#1FFFFFFF" />
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </ui:Button.Style>
                                    <ui:SymbolIcon FontSize="14">
                                        <ui:SymbolIcon.Style>
                                            <Style TargetType="ui:SymbolIcon">
                                                <Setter Property="Symbol" Value="StarOff16" />
                                                <Setter Property="Foreground" Value="#80FFFFFF" />
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsFavorite}" Value="True">
                                                        <Setter Property="Symbol" Value="Star16" />
                                                        <Setter Property="Foreground" Value="#FFD700" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </ui:SymbolIcon.Style>
                                    </ui:SymbolIcon>
                                </ui:Button>
                                <ui:Button Width="24" Height="24"
                                          Padding="0"
                                          CornerRadius="4"
                                          Command="{Binding DataContext.OpenSftpBrowserForHostCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                          CommandParameter="{Binding}"
                                          ToolTip="SFTP Browser"
                                          Margin="0,0,2,0">
                                    <ui:Button.Style>
                                        <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                                            <Setter Property="Background" Value="#0078D4" />
                                            <Style.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="Background" Value="#1084D8" />
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </ui:Button.Style>
                                    <ui:SymbolIcon Symbol="FolderOpen16" FontSize="12" Foreground="White" />
                                </ui:Button>
                                <ui:Button Icon="{ui:SymbolIcon Edit16}"
                                          Command="{Binding DataContext.EditHostCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                          CommandParameter="{Binding}"
                                          ToolTip="Edit (Ctrl+E)"
                                          Width="24" Height="24"
                                          Padding="0"
                                          Margin="0,0,2,0" />
                                <ui:Button Command="{Binding DataContext.ConnectCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                          CommandParameter="{Binding}"
                                          ToolTip="Connect (Enter)"
                                          Width="24" Height="24"
                                          Padding="0"
                                          CornerRadius="4"
                                          IsEnabled="{Binding DataContext.IsConnecting, RelativeSource={RelativeSource AncestorType=ListBox}, Converter={StaticResource InverseBoolConverter}}">
                                    <ui:Button.Style>
                                        <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                                            <Setter Property="Background" Value="#0078D4" />
                                            <Style.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="Background" Value="#1084D8" />
                                                </Trigger>
                                                <Trigger Property="IsPressed" Value="True">
                                                    <Setter Property="Background" Value="#005A9E" />
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </ui:Button.Style>
                                    <ui:SymbolIcon Symbol="Play16" FontSize="12" Foreground="White" />
                                </ui:Button>
                            </StackPanel>

                            <!-- Row 2: Connection type, Group and Hostname -->
                            <StackPanel Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="2"
                                       Orientation="Horizontal"
                                       Margin="0,2,0,0">
                                <!-- Connection type icon (SSH or Serial) -->
                                <ui:SymbolIcon Symbol="{Binding ConnectionType, Converter={StaticResource ConnectionTypeIconConverter}}"
                                              FontSize="11"
                                              Opacity="0.5"
                                              Margin="0,0,4,0"
                                              VerticalAlignment="Center">
                                    <ui:SymbolIcon.ToolTip>
                                        <TextBlock>
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Text" Value="SSH Connection" />
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding ConnectionType}" Value="Serial">
                                                            <Setter Property="Text" Value="Serial Connection" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </ui:SymbolIcon.ToolTip>
                                </ui:SymbolIcon>
                                <TextBlock Text="{Binding Group.Name, FallbackValue='Ungrouped'}"
                                          Opacity="0.5"
                                          FontSize="11"
                                          FontStyle="Italic"
                                          TextTrimming="CharacterEllipsis" />
                                <TextBlock Text=" Â· "
                                          Opacity="0.4"
                                          FontSize="11" />
                                <TextBlock Text="{Binding Hostname}"
                                          Opacity="0.7"
                                          FontSize="11"
                                          TextTrimming="CharacterEllipsis"
                                          MaxWidth="160" />
                            </StackPanel>
                        </Grid>
                    </Border>
                    </Grid>
                    </Border>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>
        </Grid>

        <!-- Action Buttons -->
        <Grid Grid.Row="4" Margin="8,8,8,12">
            <!-- Left: History, Snippets, Key Manager, and other utility buttons - spread evenly -->
            <UniformGrid Rows="1" HorizontalAlignment="Stretch">
                <ui:Button Icon="{ui:SymbolIcon History24}"
                          ToolTip="Connection History (Ctrl+H)"
                          Click="HistoryButton_Click"
                          HorizontalAlignment="Stretch"
                          Margin="2" />
                <ui:Button Icon="{ui:SymbolIcon Code24}"
                          ToolTip="Snippets (Ctrl+Shift+S)"
                          Click="SnippetsButton_Click"
                          HorizontalAlignment="Stretch"
                          Margin="2" />
                <ui:Button Icon="{ui:SymbolIcon Key24}"
                          ToolTip="SSH Key Manager"
                          Click="KeyManagerButton_Click"
                          HorizontalAlignment="Stretch"
                          Margin="2" />
                <ui:Button Icon="{ui:SymbolIcon Record24}"
                          ToolTip="Session Recordings"
                          Click="RecordingsButton_Click"
                          HorizontalAlignment="Stretch"
                          Margin="2" />
                <ui:Button Icon="{ui:SymbolIcon PlugConnected24}"
                          ToolTip="Serial Port Quick Connect (Ctrl+Shift+P)"
                          Click="SerialQuickConnectButton_Click"
                          HorizontalAlignment="Stretch"
                          Margin="2" />
            </UniformGrid>
        </Grid>
    </Grid>
</UserControl>
