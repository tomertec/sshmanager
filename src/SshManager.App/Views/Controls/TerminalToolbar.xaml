<UserControl x:Class="SshManager.App.Views.Controls.TerminalToolbar"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             xmlns:controls="clr-namespace:SshManager.App.Views.Controls"
             xmlns:terminalServices="clr-namespace:SshManager.Terminal.Services;assembly=SshManager.Terminal"
             mc:Ignorable="d"
             d:DesignHeight="50" d:DesignWidth="600">

    <!-- Terminal Toolbar Buttons -->
    <StackPanel Orientation="Horizontal"
               VerticalAlignment="Center"
               Margin="4,4,8,4">
        <!-- Broadcast Mode Toggle -->
        <Grid Margin="0,0,8,0">
            <ui:Button Command="{Binding BroadcastInput.ToggleBroadcastModeCommand}"
                      Padding="8">
                <ui:Button.Style>
                    <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                        <Setter Property="ToolTip" Value="Enable Broadcast Mode (type in all sessions)" />
                        <Setter Property="Icon" Value="{ui:SymbolIcon Send24}" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding BroadcastInput.IsBroadcastMode}" Value="True">
                                <Setter Property="ToolTip">
                                    <Setter.Value>
                                        <StackPanel>
                                            <TextBlock Text="Broadcast Mode Active" FontWeight="SemiBold" />
                                            <TextBlock Text="{Binding BroadcastInput.BroadcastSelectedCount, StringFormat='Typing to {0} session(s)'}" Opacity="0.7" />
                                        </StackPanel>
                                    </Setter.Value>
                                </Setter>
                                <Setter Property="Background" Value="#FF5500" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </ui:Button.Style>
            </ui:Button>
            <!-- Broadcast Indicator (Orange dot) -->
            <Ellipse Width="8" Height="8"
                    Fill="#FF5500"
                    HorizontalAlignment="Right"
                    VerticalAlignment="Top"
                    Margin="0,2,2,0"
                    IsHitTestVisible="False"
                    Visibility="{Binding BroadcastInput.IsBroadcastMode, Converter={StaticResource BoolToVisibilityConverter}}" />
        </Grid>
        <!-- Broadcast Select All / Deselect All (visible when broadcast mode is on) -->
        <StackPanel Orientation="Horizontal"
                   Visibility="{Binding BroadcastInput.IsBroadcastMode, Converter={StaticResource BoolToVisibilityConverter}}"
                   Margin="0,0,8,0">
            <ui:Button Icon="{ui:SymbolIcon SelectAllOn24}"
                      ToolTip="Select all sessions for broadcast"
                      Command="{Binding BroadcastInput.SelectAllForBroadcastCommand}"
                      Padding="6"
                      Margin="0,0,2,0" />
            <ui:Button Icon="{ui:SymbolIcon SelectAllOff24}"
                      ToolTip="Deselect all sessions"
                      Command="{Binding BroadcastInput.DeselectAllForBroadcastCommand}"
                      Padding="6" />
        </StackPanel>
        <!-- Separator -->
        <Border Width="1" Background="#3FFFFFFF" Margin="4,4,8,4" />
        <!-- Session Recording Toggle -->
        <Grid>
            <ui:Button x:Name="SessionLoggingButton"
                      Command="{Binding SessionLogging.ToggleSessionLoggingCommand}"
                      Padding="8"
                      Margin="0,0,4,0">
                <ui:Button.Style>
                    <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                        <Setter Property="ToolTip" Value="Start session logging" />
                        <Setter Property="Icon" Value="{ui:SymbolIcon TextDescription24}" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding SessionLogging.IsCurrentSessionLogging}" Value="True">
                                <Setter Property="ToolTip">
                                    <Setter.Value>
                                        <StackPanel>
                                            <TextBlock Text="Logging - Click to stop" FontWeight="SemiBold" />
                                            <TextBlock Text="{Binding SessionLogging.CurrentSessionLogPath}" Opacity="0.7" />
                                        </StackPanel>
                                    </Setter.Value>
                                </Setter>
                                <Setter Property="Icon" Value="{ui:SymbolIcon TextDescription24}" />
                                <Setter Property="Foreground" Value="#E81123" />
                            </DataTrigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Foreground" Value="#E81123" />
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </ui:Button.Style>
            </ui:Button>
            <!-- Recording Indicator (Red dot) -->
            <Ellipse Width="8" Height="8"
                    Fill="#E81123"
                    HorizontalAlignment="Right"
                    VerticalAlignment="Top"
                    Margin="0,2,2,0"
                    IsHitTestVisible="False"
                    Visibility="{Binding SessionLogging.IsCurrentSessionLogging, Converter={StaticResource BoolToVisibilityConverter}}" />
        </Grid>
        <!-- Session Log Options -->
        <ui:DropDownButton Icon="{ui:SymbolIcon Settings24}"
                          ToolTip="Session log options"
                          Padding="8"
                          Margin="0,0,4,0">
            <ui:DropDownButton.Flyout>
                <ContextMenu>
                    <ui:MenuItem Header="Output + Events"
                                 Command="{Binding SessionLogging.SetCurrentSessionLogLevelCommand}"
                                 CommandParameter="{x:Static terminalServices:SessionLogLevel.OutputAndEvents}" />
                    <ui:MenuItem Header="Events Only"
                                 Command="{Binding SessionLogging.SetCurrentSessionLogLevelCommand}"
                                 CommandParameter="{x:Static terminalServices:SessionLogLevel.EventsOnly}" />
                    <ui:MenuItem Header="Errors Only"
                                 Command="{Binding SessionLogging.SetCurrentSessionLogLevelCommand}"
                                 CommandParameter="{x:Static terminalServices:SessionLogLevel.ErrorsOnly}" />
                    <Separator />
                    <ui:MenuItem Header="Redact typed secrets"
                                 IsCheckable="True"
                                 IsChecked="{Binding SessionLogging.CurrentSessionRedactTypedSecrets}" />
                </ContextMenu>
            </ui:DropDownButton.Flyout>
        </ui:DropDownButton>
        <!-- Open Current Log -->
        <ui:Button Icon="{ui:SymbolIcon Open24}"
                  ToolTip="Open current session log file"
                  Command="{Binding SessionLogging.OpenCurrentSessionLogFileCommand}"
                  Padding="8"
                  Margin="0,0,4,0" />
        <!-- Open Log Directory -->
        <ui:Button Icon="{ui:SymbolIcon FolderOpen24}"
                  ToolTip="Open log directory"
                  Command="{Binding SessionLogging.OpenLogDirectoryCommand}"
                  Padding="8"
                  Margin="0,0,4,0" />
        <!-- SFTP Browser Button -->
        <ui:Button Icon="{ui:SymbolIcon Document24}"
                  ToolTip="Open SFTP File Browser (Ctrl+B)"
                  Command="{Binding SftpLauncher.OpenSftpBrowserCommand}"
                  Padding="8"
                  Margin="0,0,4,0" />
        <!-- SSH Tunnel Builder Button -->
        <ui:Button x:Name="TunnelBuilderButton"
                  Icon="{ui:SymbolIcon Flow24}"
                  ToolTip="SSH Tunnel Visual Builder"
                  Click="TunnelBuilderButton_Click"
                  Padding="8"
                  Margin="0,0,4,0" />
        <!-- Port Forwarding Button with Flyout -->
        <Grid>
            <ui:DropDownButton x:Name="PortForwardingButton"
                              Icon="{ui:SymbolIcon ArrowSync24}"
                              Padding="8">
                <ui:DropDownButton.ToolTip>
                    <StackPanel>
                        <TextBlock Text="Port Forwarding" FontWeight="SemiBold" />
                        <TextBlock Text="{Binding PortForwardingManager.ActiveSummary}" Opacity="0.7" />
                    </StackPanel>
                </ui:DropDownButton.ToolTip>
                <ui:DropDownButton.Flyout>
                    <ContextMenu MinWidth="320">
                        <ContextMenu.Template>
                            <ControlTemplate>
                                <Border Background="{DynamicResource MenuFlyoutPresenterBackground}"
                                       BorderBrush="{DynamicResource MenuFlyoutPresenterBorderBrush}"
                                       BorderThickness="1"
                                       CornerRadius="8"
                                       Padding="8">
                                    <controls:PortForwardingStatusPanel
                                        DataContext="{Binding DataContext.PortForwardingManager, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                        ManageProfilesRequested="PortForwardingPanel_ManageProfilesRequested" />
                                </Border>
                            </ControlTemplate>
                        </ContextMenu.Template>
                    </ContextMenu>
                </ui:DropDownButton.Flyout>
            </ui:DropDownButton>
            <!-- Active Indicator (Green dot when forwards active) -->
            <Ellipse Width="8" Height="8"
                    Fill="#4CAF50"
                    HorizontalAlignment="Right"
                    VerticalAlignment="Top"
                    Margin="0,2,2,0"
                    IsHitTestVisible="False"
                    Visibility="{Binding PortForwardingManager.HasActiveForwardings, Converter={StaticResource BoolToVisibilityConverter}}" />
        </Grid>
    </StackPanel>
</UserControl>
