<UserControl x:Class="SshManager.App.Views.Controls.TerminalPane"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             xmlns:terminal="clr-namespace:SshManager.Terminal.Controls;assembly=SshManager.Terminal"
             xmlns:converters="clr-namespace:SshManager.App.Converters"
             mc:Ignorable="d"
             d:DesignHeight="400" d:DesignWidth="600"
             Focusable="True"
             GotFocus="UserControl_GotFocus">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter" />
    </UserControl.Resources>

    <Border x:Name="PaneBorder"
            Background="{DynamicResource TerminalBackgroundDarkBrush}"
            CornerRadius="6"
            Margin="2"
            ClipToBounds="True">
        <Border.Style>
            <Style TargetType="Border">
                <!-- Use a local SolidColorBrush instead of DynamicResource to prevent WPF from
                     replacing the brush instance when visibility changes, which breaks animations -->
                <Setter Property="BorderBrush">
                    <Setter.Value>
                        <SolidColorBrush Color="#2A2A2A" />
                    </Setter.Value>
                </Setter>
                <Setter Property="BorderThickness" Value="1" />
                <Style.Triggers>
                    <!-- SSH connection focus: Blue border with animation -->
                    <MultiDataTrigger>
                        <MultiDataTrigger.Conditions>
                            <Condition Binding="{Binding IsFocused}" Value="True"/>
                            <Condition Binding="{Binding IsSerialSession}" Value="False"/>
                        </MultiDataTrigger.Conditions>
                        <MultiDataTrigger.EnterActions>
                            <BeginStoryboard>
                                <Storyboard>
                                    <ColorAnimation Storyboard.TargetProperty="BorderBrush.(SolidColorBrush.Color)"
                                                    To="#0078D4" Duration="0:0:0.15">
                                        <ColorAnimation.EasingFunction>
                                            <CubicEase EasingMode="EaseOut"/>
                                        </ColorAnimation.EasingFunction>
                                    </ColorAnimation>
                                </Storyboard>
                            </BeginStoryboard>
                        </MultiDataTrigger.EnterActions>
                        <MultiDataTrigger.ExitActions>
                            <BeginStoryboard>
                                <Storyboard>
                                    <ColorAnimation Storyboard.TargetProperty="BorderBrush.(SolidColorBrush.Color)"
                                                    To="#2A2A2A" Duration="0:0:0.15">
                                        <ColorAnimation.EasingFunction>
                                            <CubicEase EasingMode="EaseOut"/>
                                        </ColorAnimation.EasingFunction>
                                    </ColorAnimation>
                                </Storyboard>
                            </BeginStoryboard>
                        </MultiDataTrigger.ExitActions>
                    </MultiDataTrigger>
                    <!-- Serial connection focus: Yellow border with animation -->
                    <MultiDataTrigger>
                        <MultiDataTrigger.Conditions>
                            <Condition Binding="{Binding IsFocused}" Value="True"/>
                            <Condition Binding="{Binding IsSerialSession}" Value="True"/>
                        </MultiDataTrigger.Conditions>
                        <MultiDataTrigger.EnterActions>
                            <BeginStoryboard>
                                <Storyboard>
                                    <ColorAnimation Storyboard.TargetProperty="BorderBrush.(SolidColorBrush.Color)"
                                                    To="#D7F227" Duration="0:0:0.15">
                                        <ColorAnimation.EasingFunction>
                                            <CubicEase EasingMode="EaseOut"/>
                                        </ColorAnimation.EasingFunction>
                                    </ColorAnimation>
                                </Storyboard>
                            </BeginStoryboard>
                        </MultiDataTrigger.EnterActions>
                        <MultiDataTrigger.ExitActions>
                            <BeginStoryboard>
                                <Storyboard>
                                    <ColorAnimation Storyboard.TargetProperty="BorderBrush.(SolidColorBrush.Color)"
                                                    To="#2A2A2A" Duration="0:0:0.15">
                                        <ColorAnimation.EasingFunction>
                                            <CubicEase EasingMode="EaseOut"/>
                                        </ColorAnimation.EasingFunction>
                                    </ColorAnimation>
                                </Storyboard>
                            </BeginStoryboard>
                        </MultiDataTrigger.ExitActions>
                    </MultiDataTrigger>
                </Style.Triggers>
            </Style>
        </Border.Style>

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!-- Pane Header with enhanced visual hierarchy -->
            <Border Grid.Row="0"
                    Background="{DynamicResource TerminalHeaderBackgroundBrush}"
                    Padding="12,8"
                    CornerRadius="4,4,0,0">
                <Grid Background="Transparent">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <!-- Left: Session info with status indicator (clickable to focus pane) -->
                    <!-- Outer Border fills the column and captures clicks anywhere in the left area -->
                    <Border Grid.Column="0" Background="Transparent"
                            PreviewMouseLeftButtonDown="Header_MouseLeftButtonDown">
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                            <!-- Connection status indicator -->
                            <Ellipse Width="8" Height="8" Margin="0,0,8,0">
                                <Ellipse.Style>
                                    <Style TargetType="Ellipse">
                                        <Setter Property="Fill" Value="{DynamicResource TerminalConnectedStatusBrush}" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Session.IsConnected}" Value="False">
                                                <Setter Property="Fill" Value="{DynamicResource TerminalDisconnectedStatusBrush}" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Ellipse.Style>
                            </Ellipse>

                            <!-- Session title -->
                            <TextBlock Text="{Binding DisplayTitle}"
                                       Foreground="{DynamicResource TerminalForegroundBrush}"
                                       FontSize="13"
                                       FontWeight="SemiBold"
                                       VerticalAlignment="Center"
                                       TextTrimming="CharacterEllipsis" />

                            <!-- Hostname -->
                            <TextBlock Text="{Binding Session.Host.Hostname}"
                                       Foreground="{DynamicResource TerminalForegroundSecondaryBrush}"
                                       FontSize="11"
                                       Margin="8,0,0,0"
                                       VerticalAlignment="Center"
                                       TextTrimming="CharacterEllipsis"
                                       Visibility="{Binding Session, Converter={StaticResource NullToVisibilityConverter}, ConverterParameter=Invert}" />

                            <!-- Primary indicator badge -->
                            <Border Background="{DynamicResource TerminalPrimaryBadgeBackgroundBrush}"
                                    BorderBrush="{DynamicResource TerminalPrimaryBadgeBorderBrush}"
                                    BorderThickness="1"
                                    CornerRadius="3"
                                    Padding="6,2"
                                    Margin="8,0,0,0"
                                    Visibility="{Binding IsPrimaryForSession, Converter={StaticResource BoolToVisibilityConverter}}">
                                <TextBlock Text="PRIMARY"
                                           Foreground="{DynamicResource TerminalPrimaryBadgeForegroundBrush}"
                                           FontSize="9"
                                           FontWeight="SemiBold"
                                           VerticalAlignment="Center" />
                            </Border>
                        </StackPanel>
                    </Border>

                    <!-- Right: Recording indicator and action buttons -->
                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                        <!-- Enhanced Recording Indicator with animation -->
                        <Border x:Name="RecordingIndicator"
                                Background="{DynamicResource TerminalRecordingBadgeBackgroundBrush}"
                                BorderBrush="{DynamicResource TerminalRecordingBadgeBorderBrush}"
                                BorderThickness="1"
                                CornerRadius="4"
                                Padding="8,4"
                                Margin="0,0,8,0"
                                Visibility="Collapsed">
                            <StackPanel Orientation="Horizontal">
                                <!-- Animated recording dot -->
                                <Ellipse x:Name="RecordingDot" Width="8" Height="8" Fill="{DynamicResource TerminalRecordingBrush}">
                                    <Ellipse.Style>
                                        <Style TargetType="Ellipse">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding Session.IsRecording}" Value="True">
                                                    <DataTrigger.EnterActions>
                                                        <BeginStoryboard>
                                                            <Storyboard RepeatBehavior="Forever">
                                                                <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                                 From="1" To="0.3" Duration="0:0:0.6"
                                                                                 AutoReverse="True">
                                                                    <DoubleAnimation.EasingFunction>
                                                                        <SineEase EasingMode="EaseInOut"/>
                                                                    </DoubleAnimation.EasingFunction>
                                                                </DoubleAnimation>
                                                            </Storyboard>
                                                        </BeginStoryboard>
                                                    </DataTrigger.EnterActions>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Ellipse.Style>
                                </Ellipse>
                                <TextBlock Text="REC"
                                           Foreground="{DynamicResource TerminalRecordingBrush}"
                                           FontSize="11"
                                           FontWeight="SemiBold"
                                           Margin="6,0,0,0"
                                           VerticalAlignment="Center"/>
                            </StackPanel>
                        </Border>

                        <!-- Action buttons -->
                        <ui:Button x:Name="RecordButton"
                                   Appearance="Secondary"
                                   Icon="{ui:SymbolIcon Video20}"
                                   ToolTip="Start/Stop Recording"
                                   Click="RecordButton_Click"
                                   Margin="4,0">
                            <ui:Button.Style>
                                <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Foreground" Value="{DynamicResource TerminalRecordButtonHoverBrush}" />
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </ui:Button.Style>
                        </ui:Button>
                        <ui:Button Appearance="Secondary"
                                   Icon="{ui:SymbolIcon SplitVertical20}"
                                   ToolTip="Split Vertical (Ctrl+Shift+D)"
                                   Click="SplitVertical_Click"
                                   Margin="4,0">
                            <ui:Button.Style>
                                <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Foreground" Value="{DynamicResource TerminalSplitButtonHoverBrush}" />
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </ui:Button.Style>
                        </ui:Button>
                        <ui:Button Appearance="Secondary"
                                   Icon="{ui:SymbolIcon SplitHorizontal20}"
                                   ToolTip="Split Horizontal (Ctrl+Shift+E)"
                                   Click="SplitHorizontal_Click"
                                   Margin="4,0">
                            <ui:Button.Style>
                                <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Foreground" Value="{DynamicResource TerminalSplitButtonHoverBrush}" />
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </ui:Button.Style>
                        </ui:Button>
                        <ui:Button Appearance="Secondary"
                                   Icon="{ui:SymbolIcon Dismiss16}"
                                   ToolTip="Close Pane (Ctrl+Shift+W)"
                                   Click="ClosePane_Click">
                            <ui:Button.Style>
                                <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Foreground" Value="{DynamicResource TerminalCloseButtonHoverBrush}" />
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </ui:Button.Style>
                        </ui:Button>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Terminal Control - Using EasyWindowsTerminalControl (Windows Terminal engine) -->
            <terminal:SshTerminalControl Grid.Row="1"
                                         x:Name="Terminal"
                                         Loaded="Terminal_Loaded"
                                         GotFocus="Terminal_GotFocus" />

            <!-- Empty pane overlay -->
            <Border Grid.Row="1"
                    Background="{DynamicResource TerminalBackgroundDarkBrush}"
                    Visibility="{Binding Session, Converter={StaticResource NullToVisibilityConverter}}">
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                    <ui:SymbolIcon Symbol="DesktopSignal24" FontSize="48" Opacity="0.3" />
                    <TextBlock Text="No session"
                               Foreground="{DynamicResource TerminalForegroundTertiaryBrush}"
                               FontSize="14"
                               Margin="0,12,0,0"
                               HorizontalAlignment="Center" />
                    <TextBlock Text="Connect to a host from the list"
                               Foreground="{DynamicResource TerminalForegroundDisabledBrush}"
                               FontSize="12"
                               Margin="0,4,0,0"
                               HorizontalAlignment="Center" />
                </StackPanel>
            </Border>
        </Grid>
    </Border>
</UserControl>
