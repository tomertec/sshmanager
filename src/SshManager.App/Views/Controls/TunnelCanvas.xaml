<UserControl x:Class="SshManager.App.Views.Controls.TunnelCanvas"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             xmlns:vm="clr-namespace:SshManager.App.ViewModels"
             xmlns:converters="clr-namespace:SshManager.App.Converters"
             mc:Ignorable="d"
             d:DataContext="{d:DesignInstance Type=vm:TunnelBuilderViewModel}"
             d:DesignHeight="600" d:DesignWidth="800"
             ClipToBounds="True"
             Focusable="True">

    <UserControl.Resources>
        <converters:GroupColorConverter x:Key="GroupColorConverter" />
    </UserControl.Resources>

    <Grid x:Name="RootGrid">
        <!-- Grid pattern background -->
        <Grid.Background>
            <DrawingBrush TileMode="Tile"
                          Viewport="0,0,20,20"
                          ViewportUnits="Absolute">
                <DrawingBrush.Drawing>
                    <DrawingGroup>
                        <GeometryDrawing>
                            <GeometryDrawing.Geometry>
                                <RectangleGeometry Rect="0,0,20,20" />
                            </GeometryDrawing.Geometry>
                            <GeometryDrawing.Pen>
                                <Pen Brush="#10FFFFFF" Thickness="0.5" />
                            </GeometryDrawing.Pen>
                        </GeometryDrawing>
                    </DrawingGroup>
                </DrawingBrush.Drawing>
            </DrawingBrush>
        </Grid.Background>

        <!-- Canvas for nodes and edges with transform -->
        <Canvas x:Name="MainCanvas"
                Background="Transparent"
                MouseLeftButtonDown="Canvas_MouseLeftButtonDown"
                MouseLeftButtonUp="Canvas_MouseLeftButtonUp"
                MouseMove="Canvas_MouseMove"
                MouseWheel="Canvas_MouseWheel"
                MouseRightButtonDown="Canvas_MouseRightButtonDown"
                MouseRightButtonUp="Canvas_MouseRightButtonUp">
            <Canvas.RenderTransform>
                <TransformGroup>
                    <ScaleTransform x:Name="CanvasScaleTransform" ScaleX="1" ScaleY="1" />
                    <TranslateTransform x:Name="CanvasTranslateTransform" X="0" Y="0" />
                </TransformGroup>
            </Canvas.RenderTransform>

            <!-- Edges layer (drawn first, behind nodes) -->
            <ItemsControl ItemsSource="{Binding Edges}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <Canvas />
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="{x:Type vm:TunnelEdgeViewModel}">
                        <!-- Path for bezier curve edge -->
                        <Path Stroke="#60FFFFFF"
                              StrokeThickness="2"
                              StrokeDashArray="5,3"
                              MouseLeftButtonDown="Edge_MouseLeftButtonDown">
                            <Path.Data>
                                <PathGeometry>
                                    <PathFigure StartPoint="{Binding StartPoint}">
                                        <BezierSegment Point1="{Binding ControlPoint1}"
                                                       Point2="{Binding ControlPoint2}"
                                                       Point3="{Binding EndPoint}" />
                                    </PathFigure>
                                </PathGeometry>
                            </Path.Data>
                        </Path>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

            <!-- Nodes layer -->
            <ItemsControl ItemsSource="{Binding Nodes}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <Canvas />
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemContainerStyle>
                    <Style TargetType="ContentPresenter">
                        <Setter Property="Canvas.Left" Value="{Binding X}" />
                        <Setter Property="Canvas.Top" Value="{Binding Y}" />
                    </Style>
                </ItemsControl.ItemContainerStyle>
                <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="{x:Type vm:TunnelNodeViewModel}">
                        <!-- Node visual -->
                        <Border MinWidth="120" MinHeight="80"
                                MouseLeftButtonDown="Node_MouseLeftButtonDown"
                                MouseLeftButtonUp="Node_MouseLeftButtonUp"
                                MouseMove="Node_MouseMove"
                                Background="{Binding NodeColor, Converter={StaticResource GroupColorConverter}}"
                                BorderBrush="{Binding BorderBrush}"
                                BorderThickness="{Binding BorderThickness}"
                                CornerRadius="8"
                                Padding="12,10"
                                Cursor="Hand">
                            <Border.Effect>
                                <DropShadowEffect BlurRadius="8"
                                                  ShadowDepth="2"
                                                  Opacity="0.3"
                                                  Color="Black" />
                            </Border.Effect>

                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="*" />
                                </Grid.RowDefinitions>

                                <!-- Node icon -->
                                <ui:SymbolIcon Grid.Row="0"
                                               Symbol="{Binding NodeSymbol}"
                                               FontSize="24"
                                               Foreground="White"
                                               HorizontalAlignment="Center"
                                               Margin="0,0,0,6" />

                                <!-- Node label -->
                                <TextBlock Grid.Row="1"
                                           Text="{Binding DisplayLabel}"
                                           Foreground="White"
                                           FontSize="12"
                                           FontWeight="SemiBold"
                                           TextAlignment="Center"
                                           TextWrapping="Wrap"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center" />
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </Canvas>

        <!-- Zoom controls overlay -->
        <StackPanel VerticalAlignment="Bottom"
                    HorizontalAlignment="Right"
                    Margin="16"
                    Orientation="Horizontal">
            <ui:Button Content="Reset View"
                       Appearance="Secondary"
                       Click="ResetView_Click"
                       Padding="8,4"
                       Margin="0,0,8,0">
                <ui:Button.Icon>
                    <ui:SymbolIcon Symbol="ArrowCounterclockwise24" />
                </ui:Button.Icon>
            </ui:Button>
            <TextBlock Text="{Binding ElementName=CanvasScaleTransform, Path=ScaleX, StringFormat={}{0:P0}}"
                       VerticalAlignment="Center"
                       FontSize="12"
                       Opacity="0.7"
                       Margin="8,0" />
        </StackPanel>
    </Grid>
</UserControl>
