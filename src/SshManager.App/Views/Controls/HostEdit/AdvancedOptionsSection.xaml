<UserControl x:Class="SshManager.App.Views.Controls.HostEdit.AdvancedOptionsSection"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             xmlns:models="clr-namespace:SshManager.Core.Models;assembly=SshManager.Core"
             mc:Ignorable="d"
             d:DesignHeight="800" d:DesignWidth="400">

    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="HostEditResources.xaml" />
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </UserControl.Resources>

    <Expander Header="Advanced Options" Margin="0,8,0,0">
        <StackPanel Margin="0,12,0,0">
            <!-- ProxyJump Profile -->
            <TextBlock Text="ProxyJump Profile"
                       Style="{StaticResource SectionLabelStyle}" />
            <Grid Margin="0,0,0,8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <ComboBox Grid.Column="0"
                          ItemsSource="{Binding AvailableProxyJumpProfiles}"
                          SelectedItem="{Binding SelectedProxyJumpProfile}"
                          Margin="0,0,4,0">
                    <ComboBox.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal">
                                <ui:SymbolIcon Symbol="ArrowSync24" FontSize="14" Margin="0,0,6,0" />
                                <TextBlock Text="{Binding DisplayName}" />
                            </StackPanel>
                        </DataTemplate>
                    </ComboBox.ItemTemplate>
                </ComboBox>
                <ui:Button Grid.Column="1"
                           Icon="{ui:SymbolIcon Dismiss16}"
                           ToolTip="Clear selection"
                           Command="{Binding ClearProxyJumpProfileCommand}"
                           Width="32" Height="32"
                           Padding="0"
                           Margin="0,0,4,0" />
                <ui:Button Grid.Column="2"
                           x:Name="ManageProxyJumpButton"
                           Icon="{ui:SymbolIcon Settings16}"
                           ToolTip="Manage ProxyJump profiles"
                           Click="ManageProxyJumpProfiles_Click"
                           Width="32" Height="32"
                           Padding="0" />
            </Grid>
            <TextBlock Text="Connect through a bastion/jump host or chain of hosts"
                       Style="{StaticResource HintTextStyle}"
                       Margin="0,0,0,16" />

            <!-- Port Forwarding -->
            <TextBlock Text="Port Forwarding"
                       Style="{StaticResource SectionLabelStyle}" />
            <Grid Margin="0,0,0,8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <Border Grid.Column="0"
                        Style="{StaticResource StatusBorderStyle}">
                    <TextBlock Text="{Binding PortForwardingStatusText}"
                               Opacity="0.8"
                               VerticalAlignment="Center" />
                </Border>
                <ui:Button Grid.Column="1"
                           x:Name="ManagePortForwardingButton"
                           Icon="{ui:SymbolIcon Settings16}"
                           Content="Manage"
                           ToolTip="Manage port forwarding profiles for this host"
                           Click="ManagePortForwarding_Click"
                           Padding="12,6"
                           Margin="8,0,0,0" />
            </Grid>
            <TextBlock Text="Configure local, remote, or dynamic (SOCKS) port forwarding"
                       Style="{StaticResource HintTextStyle}"
                       Margin="0,0,0,16" />

            <!-- Shell Type -->
            <TextBlock Text="Shell Type"
                       Style="{StaticResource SectionLabelStyle}" />
            <ComboBox ItemsSource="{Binding ShellTypes}"
                      SelectedItem="{Binding ShellType}"
                      Margin="0,0,0,4">
                <ComboBox.ItemTemplate>
                    <DataTemplate>
                        <TextBlock>
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Text" Value="{Binding}" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding}" Value="{x:Static models:ShellType.Auto}">
                                            <Setter Property="Text" Value="Auto (Assume POSIX)" />
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding}" Value="{x:Static models:ShellType.Posix}">
                                            <Setter Property="Text" Value="POSIX (bash/zsh/sh)" />
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding}" Value="{x:Static models:ShellType.PowerShell}">
                                            <Setter Property="Text" Value="PowerShell" />
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding}" Value="{x:Static models:ShellType.Cmd}">
                                            <Setter Property="Text" Value="Command Prompt (CMD)" />
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding}" Value="{x:Static models:ShellType.NetworkAppliance}">
                                            <Setter Property="Text" Value="Network Appliance (Cisco/Juniper)" />
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding}" Value="{x:Static models:ShellType.Other}">
                                            <Setter Property="Text" Value="Other (Skip env vars)" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </DataTemplate>
                </ComboBox.ItemTemplate>
            </ComboBox>
            <TextBlock Text="Determines how environment variables are applied (non-POSIX shells skip env vars)"
                       Style="{StaticResource HintTextStyle}"
                       Margin="0,0,0,16" />

            <!-- Keep-Alive Settings (SSH only) -->
            <StackPanel Visibility="{Binding IsSshConnection, Converter={StaticResource BoolToVisibilityConverter}}">
                <TextBlock Text="Keep-Alive Interval"
                           Style="{StaticResource SectionLabelStyle}" />
                <TextBlock Text="Send periodic packets to prevent connection timeout"
                           Style="{StaticResource HintTextStyle}"
                           Margin="0,0,0,8" />

                <CheckBox Content="Use global setting"
                          IsChecked="{Binding UseGlobalKeepAliveSetting, Mode=TwoWay}"
                          Margin="0,0,0,8" />

                <StackPanel Visibility="{Binding UseGlobalKeepAliveSetting, Converter={StaticResource InverseBoolToVisibilityConverter}}"
                            Margin="0,0,0,8">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <Slider Grid.Column="0"
                                Minimum="0"
                                Maximum="300"
                                Value="{Binding KeepAliveIntervalSeconds, Mode=TwoWay}"
                                TickFrequency="30"
                                IsSnapToTickEnabled="True"
                                AutoToolTipPlacement="TopLeft"
                                Margin="0,0,8,0" />
                        <TextBlock Grid.Column="1"
                                   Text="{Binding KeepAliveIntervalSeconds, StringFormat='{}{0} sec'}"
                                   FontWeight="SemiBold"
                                   VerticalAlignment="Center"
                                   MinWidth="60"
                                   TextAlignment="Right" />
                    </Grid>
                    <TextBlock Style="{StaticResource HintTextStyle}" Margin="0,4,0,0">
                        <Run Text="0 = disabled" />
                        <Run Text="  |  " />
                        <Run Text="Recommended: 30-120 seconds" />
                    </TextBlock>
                </StackPanel>
            </StackPanel>

            <!-- X11 Forwarding Settings (SSH only) -->
            <StackPanel Visibility="{Binding IsSshConnection, Converter={StaticResource BoolToVisibilityConverter}}"
                        Margin="0,16,0,0">
                <TextBlock Text="X11 Forwarding"
                           Style="{StaticResource SectionLabelStyle}" />
                <TextBlock Text="Forward X11 display to local X server (requires local X server)"
                           Style="{StaticResource HintTextStyle}"
                           Margin="0,0,0,8" />

                <!-- Enable X11 Forwarding -->
                <Grid Margin="0,0,0,12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <StackPanel Grid.Column="0">
                        <TextBlock Text="Enable X11 Forwarding" FontWeight="SemiBold"/>
                        <TextBlock Text="Forward X11 display to local X server"
                                   Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"
                                   FontSize="12"/>
                    </StackPanel>
                    <CheckBox Grid.Column="1"
                              IsChecked="{Binding X11ForwardingEnabled, Mode=TwoWay}"
                              VerticalAlignment="Center"/>
                </Grid>

                <!-- X11 Options (visible when enabled) -->
                <StackPanel Visibility="{Binding X11ForwardingEnabled, Converter={StaticResource BoolToVisibilityConverter}}"
                            Margin="0,0,0,8">

                    <!-- Trusted Forwarding -->
                    <Grid Margin="0,0,0,12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <StackPanel Grid.Column="0">
                            <TextBlock Text="Trusted Forwarding" FontWeight="SemiBold"/>
                            <TextBlock Text="Use -Y instead of -X (less secure, more compatible)"
                                       Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"
                                       FontSize="12"/>
                        </StackPanel>
                        <CheckBox Grid.Column="1"
                                  IsChecked="{Binding X11TrustedForwarding, Mode=TwoWay}"
                                  VerticalAlignment="Center"/>
                    </Grid>

                    <!-- Display Number -->
                    <TextBlock Text="Display Number"
                               Style="{StaticResource SectionLabelStyle}" />
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="120"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <ui:NumberBox Grid.Column="0"
                                      Value="{Binding X11DisplayNumber}"
                                      Minimum="0"
                                      Maximum="63"
                                      SpinButtonPlacementMode="Compact"
                                      PlaceholderText="0"/>
                        <TextBlock Grid.Column="1"
                                   Text="Display :0 is default"
                                   Style="{StaticResource HintTextStyle}"
                                   VerticalAlignment="Center"
                                   Margin="12,0,0,0" />
                    </Grid>
                </StackPanel>
            </StackPanel>

            <!-- Environment Variables Section -->
            <TextBlock Text="Environment Variables"
                       Style="{StaticResource SectionLabelStyle}"
                       Margin="0,16,0,0" />
            <TextBlock Text="Variables set when establishing SSH connections"
                       Style="{StaticResource HintTextStyle}"
                       Margin="0,0,0,8" />

            <!-- Environment Variables List -->
            <Border Style="{StaticResource StatusBorderStyle}"
                    Padding="8"
                    Margin="0,0,0,8">
                <StackPanel>
                    <!-- Header Row -->
                    <Grid Margin="0,0,0,8"
                          Visibility="{Binding EnvironmentVariables.Count, Converter={StaticResource BoolToVisibilityConverter}}">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="60" />
                            <ColumnDefinition Width="32" />
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0" Text="Name" FontWeight="SemiBold" FontSize="11" Opacity="0.7" Margin="4,0" />
                        <TextBlock Grid.Column="1" Text="Value" FontWeight="SemiBold" FontSize="11" Opacity="0.7" Margin="4,0" />
                        <TextBlock Grid.Column="2" Text="Enabled" FontWeight="SemiBold" FontSize="11" Opacity="0.7" HorizontalAlignment="Center" />
                    </Grid>

                    <!-- Environment Variables Items -->
                    <ItemsControl ItemsSource="{Binding EnvironmentVariables}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Grid Margin="0,0,0,6">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="60" />
                                        <ColumnDefinition Width="32" />
                                    </Grid.ColumnDefinitions>
                                    <ui:TextBox Grid.Column="0"
                                                Text="{Binding Name, UpdateSourceTrigger=PropertyChanged}"
                                                PlaceholderText="VARIABLE"
                                                Margin="0,0,4,0" />
                                    <ui:TextBox Grid.Column="1"
                                                Text="{Binding Value, UpdateSourceTrigger=PropertyChanged}"
                                                PlaceholderText="value"
                                                Margin="0,0,4,0" />
                                    <CheckBox Grid.Column="2"
                                              IsChecked="{Binding IsEnabled}"
                                              HorizontalAlignment="Center"
                                              VerticalAlignment="Center" />
                                    <ui:Button Grid.Column="3"
                                               Icon="{ui:SymbolIcon Delete16}"
                                               ToolTip="Remove variable"
                                               Command="{Binding DataContext.RemoveEnvironmentVariableCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                               CommandParameter="{Binding}"
                                               Width="28" Height="28"
                                               Padding="0" />
                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- Empty State -->
                    <TextBlock Text="No environment variables configured"
                               FontSize="12"
                               Opacity="0.5"
                               HorizontalAlignment="Center"
                               Margin="0,8"
                               Visibility="{Binding HasNoEnvironmentVariables, Converter={StaticResource BoolToVisibilityConverter}}" />

                    <!-- Add Button -->
                    <ui:Button Icon="{ui:SymbolIcon Add16}"
                               Content="Add Variable"
                               Command="{Binding AddEnvironmentVariableCommand}"
                               Margin="0,8,0,0"
                               Padding="8,4" />
                </StackPanel>
            </Border>

            <!-- Quick Presets -->
            <StackPanel Orientation="Horizontal" Margin="0,0,0,0">
                <TextBlock Text="Quick add:"
                           Style="{StaticResource HintTextStyle}"
                           VerticalAlignment="Center"
                           Margin="0,0,8,0" />
                <ui:Button Content="TERM=xterm-256color"
                           Command="{Binding AddPresetEnvironmentVariableCommand}"
                           CommandParameter="TERM=xterm-256color"
                           Appearance="Secondary"
                           FontSize="11"
                           Padding="8,4"
                           Height="26"
                           Margin="0,0,4,0" />
                <ui:Button Content="LANG=en_US.UTF-8"
                           Command="{Binding AddPresetEnvironmentVariableCommand}"
                           CommandParameter="LANG=en_US.UTF-8"
                           Appearance="Secondary"
                           FontSize="11"
                           Padding="8,4"
                           Height="26" />
            </StackPanel>
        </StackPanel>
    </Expander>
</UserControl>
