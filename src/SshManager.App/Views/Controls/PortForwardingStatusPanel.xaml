<UserControl x:Class="SshManager.App.Views.Controls.PortForwardingStatusPanel"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             xmlns:converters="clr-namespace:SshManager.App.Converters"
             xmlns:vm="clr-namespace:SshManager.App.ViewModels"
             mc:Ignorable="d"
             d:DesignHeight="300" d:DesignWidth="350">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter" />
    </UserControl.Resources>

    <Border Background="#1FFFFFFF"
            CornerRadius="8"
            BorderBrush="#2FFFFFFF"
            BorderThickness="1"
            Padding="12">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- Header -->
            <Grid Grid.Row="0" Margin="0,0,0,12">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <ui:SymbolIcon Grid.Column="0"
                              Symbol="ArrowSync24"
                              FontSize="18"
                              Margin="0,0,8,0" />

                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                    <TextBlock Text="Port Forwards"
                              FontWeight="SemiBold"
                              FontSize="13" />
                    <TextBlock Text="{Binding ActiveSummary}"
                              FontSize="11"
                              Opacity="0.6" />
                </StackPanel>

                <ui:Button Grid.Column="2"
                          Icon="{ui:SymbolIcon Stop24}"
                          ToolTip="Stop All"
                          Command="{Binding StopAllCommand}"
                          Visibility="{Binding HasActiveForwardings, Converter={StaticResource BoolToVisibilityConverter}}"
                          Width="28" Height="28"
                          Padding="0" />
            </Grid>

            <!-- Active Forwardings List -->
            <ScrollViewer Grid.Row="1"
                          VerticalScrollBarVisibility="Auto"
                          MaxHeight="250">
                <ItemsControl ItemsSource="{Binding ActiveForwardings}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate DataType="{x:Type vm:ActivePortForwardingViewModel}">
                            <Border Background="#15FFFFFF"
                                   CornerRadius="6"
                                   Padding="10,8"
                                   Margin="0,0,0,6">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <!-- Status Indicator -->
                                    <Grid Grid.Column="0" Margin="0,0,10,0" VerticalAlignment="Center">
                                        <!-- Active -->
                                        <Ellipse Width="10" Height="10"
                                                Fill="#4CAF50"
                                                Visibility="{Binding IsActive, Converter={StaticResource BoolToVisibilityConverter}}" />
                                        <!-- Starting -->
                                        <ui:ProgressRing Width="12" Height="12"
                                                        IsIndeterminate="True">
                                            <ui:ProgressRing.Style>
                                                <Style TargetType="ui:ProgressRing">
                                                    <Setter Property="Visibility" Value="Collapsed" />
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding Status}" Value="{x:Static vm:PortForwardingStatus.Starting}">
                                                            <Setter Property="Visibility" Value="Visible" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ui:ProgressRing.Style>
                                        </ui:ProgressRing>
                                        <!-- Failed -->
                                        <Ellipse Width="10" Height="10"
                                                Fill="#F44336">
                                            <Ellipse.Style>
                                                <Style TargetType="Ellipse">
                                                    <Setter Property="Visibility" Value="Collapsed" />
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding Status}" Value="{x:Static vm:PortForwardingStatus.Failed}">
                                                            <Setter Property="Visibility" Value="Visible" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Ellipse.Style>
                                        </Ellipse>
                                        <!-- Stopped -->
                                        <Ellipse Width="10" Height="10"
                                                Fill="#9E9E9E">
                                            <Ellipse.Style>
                                                <Style TargetType="Ellipse">
                                                    <Setter Property="Visibility" Value="Collapsed" />
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding Status}" Value="{x:Static vm:PortForwardingStatus.Stopped}">
                                                            <Setter Property="Visibility" Value="Visible" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Ellipse.Style>
                                        </Ellipse>
                                    </Grid>

                                    <!-- Info -->
                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                        <TextBlock Text="{Binding DisplayName}"
                                                  FontWeight="SemiBold"
                                                  FontSize="12"
                                                  TextTrimming="CharacterEllipsis" />
                                        <TextBlock Text="{Binding ForwardingDescription}"
                                                  FontFamily="Consolas"
                                                  FontSize="10"
                                                  Opacity="0.7"
                                                  TextTrimming="CharacterEllipsis" />
                                        <StackPanel Orientation="Horizontal" Margin="0,2,0,0">
                                            <TextBlock Text="{Binding SessionName}"
                                                      FontSize="10"
                                                      Opacity="0.5" />
                                            <TextBlock Text=" | "
                                                      FontSize="10"
                                                      Opacity="0.3" />
                                            <TextBlock Text="{Binding BytesTransferredDisplay}"
                                                      FontSize="10"
                                                      Opacity="0.5" />
                                        </StackPanel>
                                        <!-- Error Message -->
                                        <TextBlock Text="{Binding ErrorMessage}"
                                                  FontSize="10"
                                                  Foreground="#F44336"
                                                  TextWrapping="Wrap"
                                                  Margin="0,2,0,0">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Visibility" Value="Collapsed" />
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding Status}" Value="{x:Static vm:PortForwardingStatus.Failed}">
                                                            <Setter Property="Visibility" Value="Visible" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </StackPanel>

                                    <!-- Stop Button -->
                                    <ui:Button Grid.Column="2"
                                              Icon="{ui:SymbolIcon Dismiss16}"
                                              ToolTip="Stop"
                                              Command="{Binding DataContext.StopForwardingCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                              CommandParameter="{Binding}"
                                              Visibility="{Binding CanStop, Converter={StaticResource BoolToVisibilityConverter}}"
                                              Width="24" Height="24"
                                              Padding="0"
                                              VerticalAlignment="Center" />
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>

            <!-- Empty State -->
            <StackPanel Grid.Row="1"
                       VerticalAlignment="Center"
                       HorizontalAlignment="Center"
                       Visibility="{Binding HasActiveForwardings, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                <ui:SymbolIcon Symbol="PlugDisconnected24"
                              FontSize="32"
                              Opacity="0.3"
                              HorizontalAlignment="Center"
                              Margin="0,0,0,8" />
                <TextBlock Text="No active port forwards"
                          FontSize="11"
                          Opacity="0.4"
                          HorizontalAlignment="Center" />
            </StackPanel>

            <!-- Footer with Manage link -->
            <Grid Grid.Row="2" Margin="0,12,0,0">
                <ui:Button Content="Manage Profiles"
                          Icon="{ui:SymbolIcon Settings16}"
                          HorizontalAlignment="Stretch"
                          Click="ManageProfiles_Click"
                          Padding="8,6" />
            </Grid>
        </Grid>
    </Border>
</UserControl>
